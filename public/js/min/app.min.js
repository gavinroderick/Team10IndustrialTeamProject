google.charts.load('current', {packages: ['corechart', 'line']});
google.charts.setOnLoadCallback(drawBasic);


    // var groundFloor;
    // var groundFloorReqURL = 'api/groundFloorStores.json';
    // var groundFloorReq = new XMLHttpRequest();
    // groundFloorReq.open('GET', groundFloorReqURL);
    // groundFloorReq.send();
    // groundFloorReq.onload = () => {
    //     var groundFloorStores = groundFloorReq.response;
    //     var obj = JSON.parse(groundFloorStores);
    //     groundFloor = obj;
    // }

    // var firstFloor;
    // var firstFloorReqURL = 'api/firstFloorStores.json';
    // var firstFloorReq = new XMLHttpRequest();
    // firstFloorReq.open('GET', firstFloorReqURL);
    // firstFloorReq.send();
    // firstFloorReq.onload = () => {
    //     var firstFloorStores = firstFloorReq.response;
    //     var obj = JSON.parse(firstFloorStores);
    //     firstFloor = obj;
    // }

    // var storeData;
    // var storeReqURL = 'api/data.json';
    // var storeReq = new XMLHttpRequest();
    // storeReq.open('GET', storeReqURL);
    // storeReq.send();
    // storeReq.onload = () => {
    //     var storeDatas = storeReq.response;
    //     var obj = JSON.parse(storeDatas);
    //     storeData = obj;
    // }

function drawBasic(id) {

    var store;

    var currentTime = new Date();
    var currentTimeArray = currentTime.toLocaleTimeString('it-IT').split(':');


    for( var i = 0; i < groundFloor.stores.length; i++)
    {
        if (storeData[i]['id'] == id)
        {
            store = i;
            break;
        }
    }
    for( var i = 0; i < firstFloor.stores.length; i++)
    {
        if (storeData[i]['id'] == id)
        {
            store = i;
            break;
        }
    }

    var data = new google.visualization.DataTable();

    data.addColumn('string', 'Time');
    data.addColumn('number', 'Occupancy');
    data.addColumn('number', 'Noise');
    data.addColumn('number', 'Humidity');
    data.addColumn('number', 'Occupancy Prediction');
    data.addColumn('number', 'Noise Prediction');
    data.addColumn('number', 'Humidity Prediction');


    for( var i = 1; i < 41; i++)
    {

      var timeslot = storeData[store]['history'][0]['times'][i-1]['timeslot'].toString();
      var timeslotArray = timeslot.split('');
      
      var hour = timeslotArray[11].concat(timeslotArray[12]);
      var min = timeslotArray[14].concat(timeslotArray[15]);
      var time = hour.concat(":");
      time = time.concat(min);

      if(hour < currentTimeArray[0])
      {
        data.addRows([
              [
                  
                  time, 
                  storeData[store]['history'][0]['times'][i-1]['occupancy']*100, 
                  storeData[store]['history'][0]['times'][i-1]['noise']*100,
                  storeData[store]['history'][0]['times'][i-1]['humidity']*100,
                  null,
                  null,
                  null
              ]
          ]
          );
      } else if (hour == currentTimeArray[0]){
        if(min <= currentTimeArray[1])
        {
          data.addRows([
              [
                  
                  time, 
                  storeData[store]['history'][0]['times'][i-1]['occupancy']*100, 
                  storeData[store]['history'][0]['times'][i-1]['noise']*100,
                  storeData[store]['history'][0]['times'][i-1]['humidity']*100,
                  null,
                  null,
                  null
              ]
          ]
          );
        } else {
          data.addRows([
              [
                  
                  time, 
                  null, 
                  null,
                  null,
                  storeData[store]['history'][0]['times'][i-1]['occupancy']*100, 
                  storeData[store]['history'][0]['times'][i-1]['noise']*100,
                  storeData[store]['history'][0]['times'][i-1]['humidity']*100
              ]
          ]
          );
        }
      }else {
        data.addRows([
              [
                  
                  time, 
                  null, 
                  null,
                  null,
                  storeData[store]['history'][0]['times'][i-1]['occupancy']*100, 
                  storeData[store]['history'][0]['times'][i-1]['noise']*100,
                  storeData[store]['history'][0]['times'][i-1]['humidity']*100
              ]
          ]
          );
      }
    }


      var options = {
        hAxis: { 
          showTextEvery : '4',
          gridlines :{count: '10'}
        },
        vAxis: {
          baseline: 0
        },
        curveType: 'function',
        width: '700',
        legend: { position: 'bottom' }
      };

    var chart_div = document.getElementById('chart_div');
    var chart = new google.visualization.LineChart(chart_div);

    // Wait for the chart to finish drawing before calling the getImageURI() method.
    google.visualization.events.addListener(chart, 'ready', function () { });

    chart.draw(data, options);
    return('<img src="' + chart.getImageURI() + '">');
}
    var groundFloor;
    var groundFloorReqURL = 'api/groundFloorStores.json';
    var groundFloorReq = new XMLHttpRequest();
    groundFloorReq.open('GET', groundFloorReqURL);
    groundFloorReq.send();
    groundFloorReq.onload = () => {
        var groundFloorStores = groundFloorReq.response;
        var obj = JSON.parse(groundFloorStores);
        groundFloor = obj;
    }

    var firstFloor;
    var firstFloorReqURL = 'api/firstFloorStores.json';
    var firstFloorReq = new XMLHttpRequest();
    firstFloorReq.open('GET', firstFloorReqURL);
    firstFloorReq.send();
    firstFloorReq.onload = () => {
        var firstFloorStores = firstFloorReq.response;
        var obj = JSON.parse(firstFloorStores);
        firstFloor = obj;
    }

    var storeData;
    var storeReqURL = 'api/data.json';
    var storeReq = new XMLHttpRequest();
    storeReq.open('GET', storeReqURL);
    storeReq.send();
    storeReq.onload = () => {
        var storeDatas = storeReq.response;
        var obj = JSON.parse(storeDatas);
        storeData = obj;
    }

var groundFloor;
var groundFloorReqURL = 'api/groundFloorStores.json';
var groundFloorReq = new XMLHttpRequest();
groundFloorReq.open('GET', groundFloorReqURL);
groundFloorReq.send();
groundFloorReq.onload = () => {
    var groundFloorStores = groundFloorReq.response;
    var obj = JSON.parse(groundFloorStores);
    groundFloor = obj;
}

var firstFloor;
var firstFloorReqURL = 'api/firstFloorStores.json';
var firstFloorReq = new XMLHttpRequest();
firstFloorReq.open('GET', firstFloorReqURL);
firstFloorReq.send();
firstFloorReq.onload = () => {
    var firstFloorStores = firstFloorReq.response;
    var obj = JSON.parse(firstFloorStores);
    firstFloor = obj;
}

var storeData;
var storeReqURL = 'api/data.json';
var storeReq = new XMLHttpRequest();
storeReq.open('GET', storeReqURL);
storeReq.send();
storeReq.onload = () => {
    var storeDatas = storeReq.response;
    var obj = JSON.parse(storeDatas);
    storeData = obj;
}


function setEntityHighlights() {
    for(var i = 0; i < groundFloor.stores.length; i++){
        map.indoors.setEntityHighlights(groundFloor.stores[i].id.toString(), randomColor());
    }
    for(var i = 0; i < firstFloor.stores.length; i++){
        map.indoors.setEntityHighlights(firstFloor.stores[i].id.toString(), randomColor());
    }
}

function randomColor(){
    var red = Math.floor(Math.random() * 256);
    var green = 255 - red;
    return [red, green, 0, 200]
}

function clearEntityHighlights() {
    map.indoors.clearEntityHighlights();
}

var d = new Date();

var map = L.Wrld.map("map", "9d876646f7d83cc709edbe204c81d546", {
    center: [56.4598, -2.9728],
    zoom: 17,
    indoorsEnabled: true
  });
  var indoorControl = new WrldIndoorControl("widget-container", map);
  var currentIndoorMapId;
  var currentFloor;
  var entityIdsToPosition = {};
  var d;
  var popup;
  
  var lastMouseDown;
  function onMouseDown(event) {
    lastMouseDown = event.latlng;
  }
  
  function onIndoorEntityClicked(event) {
    event.ids.forEach(identifyEntity);
  }

  function exportIdMap() {
    console.log(JSON.stringify(entityIdsToPosition));
  }
  
  function onIndoorMapEntered(event) {
    map.indoors.setFloor(0);
    map.setView([56.4598, -2.9728], 17);
    currentIndoorMapId = event.indoorMap.getIndoorMapId();
    currentFloor = map.indoors.getFloor().getFloorIndex();
  }
  
  function onIndoorMapFloorChanged() {
    currentFloor = map.indoors.getFloor().getFloorIndex();
  }

  function getStoreName(id){
    if(currentFloor == 0)
    {
      for(var i = 0; i < groundFloor.stores.length; i++)
      {
        if(groundFloor.stores[i].id == id)
        {
          //console.log(groundFloor.stores[i].store);
          return groundFloor.stores[i].store;
        }
      }
    }
  }

  function validId(id) {

    for( var i = 0; i < groundFloor.stores.length; i++)
    {
          if (storeData[i]['id'] == id)
          {
              return i;
          }
    }
    for( var i = 0; i < firstFloor.stores.length; i++)
    {
          if (storeData[i]['id'] == id)
          {
              return i;
          }
    }
    return null;
}
  
  function identifyEntity(id) {
    var latLng = lastMouseDown;
    d = new Date();

    var valid = validId(id);

    if(valid != null)
    {
      map.setView(latLng, 17);
      
      var popupOptions = { 
        indoorMapId: currentIndoorMapId, 
        indoorMapFloorIndex: currentFloor, 
        autoClose: true, 
        closeOnClick: true,
        minWidth: "700"          
      };
      popup = L.popup(popupOptions)
        .setLatLng(latLng)
        .addTo(map)
        .setContent(createMockHTMLElement(id, d, drawBasic(id)));
      entityIdsToPosition[id] = { "latLng": latLng, "indoorId": currentIndoorMapId, "floorIndex": currentFloor } ;
    }

    setTimeout(updatePopup(id, d), 5000);
  }

  function updatePopup(id, d)
  {
    d = new Date();
    console.log(d.toLocaleTimeString('it-IT'));
    popup.setContent(createMockHTMLElement(id, d, drawBasic(id)));
  }

  map.indoors.on("indoormapenter", onIndoorMapEntered);
  map.indoors.on("indoormapfloorchange", onIndoorMapFloorChanged)
  map.indoors.on("indoorentityclick", onIndoorEntityClicked);
  map.on("mousedown", onMouseDown);

  function createMockHTMLElement(id, date, graphText){
    var graphHTML = '<div class="content">' +
                    '<h2>'+ getStoreName(id) +  ' ' + d.toLocaleTimeString('it-IT') +
                    graphText +
                    '</div>';
    return graphHTML;
}





/*                  '<div class="content">' +
                    '<h2>'+ getStoreName(id) + ' for the ' + d.getDate() + ' of Spetember 2018</h2>' +
                    graphText +
                    '</div>';
*/




// var d = new Date();
// document.getElementById("date").innerHTML = d;
//Onload function to setup sliders
window.onload = function (){
    var sliders = document.getElementsByClassName("rangePicker");
    // var textBoxes = document.getElementsByClassName("textBox");
    [].forEach.call(sliders, function (slider) {    
        slider.min = 10;
        slider.max = 50;
        slider.step = 10;
        slider.value = 30;
    });

    document.getElementById("SAD").addEventListener("click", presetsUpdate(0));
    document.getElementById("GOOD").addEventListener("click", presetsUpdate(2));
    document.getElementById("NORMAL").addEventListener("click", presetsUpdate(1));
}

function presetsUpdate(level){
    var occupancy = [10,30,50];
    var noise = [10,30,50];
    var humidity = [10,30,50];

    for(var i=0; i < 3; i++){
        document.getElementById("occupancy-slider").value = occupancy[level];
        document.getElementById("noise-slider").value = noise[level];
        document.getElementById("humidity-slider").value = humidity[level];
    }
}
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImdyYXBoLmpzIiwibG9hZERhdGEuanMiLCJtYXBIaWdobGlnaHRpbmcuanMiLCJwb3B1cHMuanMiLCJyZWFsVGltZUdyYXBoLmpzIiwic2V0dGluZ3MuanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQ3pLQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUNoQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUN0REE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FDaElBO0FBQ0E7QUNEQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EiLCJmaWxlIjoiYXBwLm1pbi5qcyIsInNvdXJjZXNDb250ZW50IjpbImdvb2dsZS5jaGFydHMubG9hZCgnY3VycmVudCcsIHtwYWNrYWdlczogWydjb3JlY2hhcnQnLCAnbGluZSddfSk7XG5nb29nbGUuY2hhcnRzLnNldE9uTG9hZENhbGxiYWNrKGRyYXdCYXNpYyk7XG5cblxuICAgIC8vIHZhciBncm91bmRGbG9vcjtcbiAgICAvLyB2YXIgZ3JvdW5kRmxvb3JSZXFVUkwgPSAnYXBpL2dyb3VuZEZsb29yU3RvcmVzLmpzb24nO1xuICAgIC8vIHZhciBncm91bmRGbG9vclJlcSA9IG5ldyBYTUxIdHRwUmVxdWVzdCgpO1xuICAgIC8vIGdyb3VuZEZsb29yUmVxLm9wZW4oJ0dFVCcsIGdyb3VuZEZsb29yUmVxVVJMKTtcbiAgICAvLyBncm91bmRGbG9vclJlcS5zZW5kKCk7XG4gICAgLy8gZ3JvdW5kRmxvb3JSZXEub25sb2FkID0gKCkgPT4ge1xuICAgIC8vICAgICB2YXIgZ3JvdW5kRmxvb3JTdG9yZXMgPSBncm91bmRGbG9vclJlcS5yZXNwb25zZTtcbiAgICAvLyAgICAgdmFyIG9iaiA9IEpTT04ucGFyc2UoZ3JvdW5kRmxvb3JTdG9yZXMpO1xuICAgIC8vICAgICBncm91bmRGbG9vciA9IG9iajtcbiAgICAvLyB9XG5cbiAgICAvLyB2YXIgZmlyc3RGbG9vcjtcbiAgICAvLyB2YXIgZmlyc3RGbG9vclJlcVVSTCA9ICdhcGkvZmlyc3RGbG9vclN0b3Jlcy5qc29uJztcbiAgICAvLyB2YXIgZmlyc3RGbG9vclJlcSA9IG5ldyBYTUxIdHRwUmVxdWVzdCgpO1xuICAgIC8vIGZpcnN0Rmxvb3JSZXEub3BlbignR0VUJywgZmlyc3RGbG9vclJlcVVSTCk7XG4gICAgLy8gZmlyc3RGbG9vclJlcS5zZW5kKCk7XG4gICAgLy8gZmlyc3RGbG9vclJlcS5vbmxvYWQgPSAoKSA9PiB7XG4gICAgLy8gICAgIHZhciBmaXJzdEZsb29yU3RvcmVzID0gZmlyc3RGbG9vclJlcS5yZXNwb25zZTtcbiAgICAvLyAgICAgdmFyIG9iaiA9IEpTT04ucGFyc2UoZmlyc3RGbG9vclN0b3Jlcyk7XG4gICAgLy8gICAgIGZpcnN0Rmxvb3IgPSBvYmo7XG4gICAgLy8gfVxuXG4gICAgLy8gdmFyIHN0b3JlRGF0YTtcbiAgICAvLyB2YXIgc3RvcmVSZXFVUkwgPSAnYXBpL2RhdGEuanNvbic7XG4gICAgLy8gdmFyIHN0b3JlUmVxID0gbmV3IFhNTEh0dHBSZXF1ZXN0KCk7XG4gICAgLy8gc3RvcmVSZXEub3BlbignR0VUJywgc3RvcmVSZXFVUkwpO1xuICAgIC8vIHN0b3JlUmVxLnNlbmQoKTtcbiAgICAvLyBzdG9yZVJlcS5vbmxvYWQgPSAoKSA9PiB7XG4gICAgLy8gICAgIHZhciBzdG9yZURhdGFzID0gc3RvcmVSZXEucmVzcG9uc2U7XG4gICAgLy8gICAgIHZhciBvYmogPSBKU09OLnBhcnNlKHN0b3JlRGF0YXMpO1xuICAgIC8vICAgICBzdG9yZURhdGEgPSBvYmo7XG4gICAgLy8gfVxuXG5mdW5jdGlvbiBkcmF3QmFzaWMoaWQpIHtcblxuICAgIHZhciBzdG9yZTtcblxuICAgIHZhciBjdXJyZW50VGltZSA9IG5ldyBEYXRlKCk7XG4gICAgdmFyIGN1cnJlbnRUaW1lQXJyYXkgPSBjdXJyZW50VGltZS50b0xvY2FsZVRpbWVTdHJpbmcoJ2l0LUlUJykuc3BsaXQoJzonKTtcblxuXG4gICAgZm9yKCB2YXIgaSA9IDA7IGkgPCBncm91bmRGbG9vci5zdG9yZXMubGVuZ3RoOyBpKyspXG4gICAge1xuICAgICAgICBpZiAoc3RvcmVEYXRhW2ldWydpZCddID09IGlkKVxuICAgICAgICB7XG4gICAgICAgICAgICBzdG9yZSA9IGk7XG4gICAgICAgICAgICBicmVhaztcbiAgICAgICAgfVxuICAgIH1cbiAgICBmb3IoIHZhciBpID0gMDsgaSA8IGZpcnN0Rmxvb3Iuc3RvcmVzLmxlbmd0aDsgaSsrKVxuICAgIHtcbiAgICAgICAgaWYgKHN0b3JlRGF0YVtpXVsnaWQnXSA9PSBpZClcbiAgICAgICAge1xuICAgICAgICAgICAgc3RvcmUgPSBpO1xuICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICB2YXIgZGF0YSA9IG5ldyBnb29nbGUudmlzdWFsaXphdGlvbi5EYXRhVGFibGUoKTtcblxuICAgIGRhdGEuYWRkQ29sdW1uKCdzdHJpbmcnLCAnVGltZScpO1xuICAgIGRhdGEuYWRkQ29sdW1uKCdudW1iZXInLCAnT2NjdXBhbmN5Jyk7XG4gICAgZGF0YS5hZGRDb2x1bW4oJ251bWJlcicsICdOb2lzZScpO1xuICAgIGRhdGEuYWRkQ29sdW1uKCdudW1iZXInLCAnSHVtaWRpdHknKTtcbiAgICBkYXRhLmFkZENvbHVtbignbnVtYmVyJywgJ09jY3VwYW5jeSBQcmVkaWN0aW9uJyk7XG4gICAgZGF0YS5hZGRDb2x1bW4oJ251bWJlcicsICdOb2lzZSBQcmVkaWN0aW9uJyk7XG4gICAgZGF0YS5hZGRDb2x1bW4oJ251bWJlcicsICdIdW1pZGl0eSBQcmVkaWN0aW9uJyk7XG5cblxuICAgIGZvciggdmFyIGkgPSAxOyBpIDwgNDE7IGkrKylcbiAgICB7XG5cbiAgICAgIHZhciB0aW1lc2xvdCA9IHN0b3JlRGF0YVtzdG9yZV1bJ2hpc3RvcnknXVswXVsndGltZXMnXVtpLTFdWyd0aW1lc2xvdCddLnRvU3RyaW5nKCk7XG4gICAgICB2YXIgdGltZXNsb3RBcnJheSA9IHRpbWVzbG90LnNwbGl0KCcnKTtcbiAgICAgIFxuICAgICAgdmFyIGhvdXIgPSB0aW1lc2xvdEFycmF5WzExXS5jb25jYXQodGltZXNsb3RBcnJheVsxMl0pO1xuICAgICAgdmFyIG1pbiA9IHRpbWVzbG90QXJyYXlbMTRdLmNvbmNhdCh0aW1lc2xvdEFycmF5WzE1XSk7XG4gICAgICB2YXIgdGltZSA9IGhvdXIuY29uY2F0KFwiOlwiKTtcbiAgICAgIHRpbWUgPSB0aW1lLmNvbmNhdChtaW4pO1xuXG4gICAgICBpZihob3VyIDwgY3VycmVudFRpbWVBcnJheVswXSlcbiAgICAgIHtcbiAgICAgICAgZGF0YS5hZGRSb3dzKFtcbiAgICAgICAgICAgICAgW1xuICAgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgICB0aW1lLCBcbiAgICAgICAgICAgICAgICAgIHN0b3JlRGF0YVtzdG9yZV1bJ2hpc3RvcnknXVswXVsndGltZXMnXVtpLTFdWydvY2N1cGFuY3knXSoxMDAsIFxuICAgICAgICAgICAgICAgICAgc3RvcmVEYXRhW3N0b3JlXVsnaGlzdG9yeSddWzBdWyd0aW1lcyddW2ktMV1bJ25vaXNlJ10qMTAwLFxuICAgICAgICAgICAgICAgICAgc3RvcmVEYXRhW3N0b3JlXVsnaGlzdG9yeSddWzBdWyd0aW1lcyddW2ktMV1bJ2h1bWlkaXR5J10qMTAwLFxuICAgICAgICAgICAgICAgICAgbnVsbCxcbiAgICAgICAgICAgICAgICAgIG51bGwsXG4gICAgICAgICAgICAgICAgICBudWxsXG4gICAgICAgICAgICAgIF1cbiAgICAgICAgICBdXG4gICAgICAgICAgKTtcbiAgICAgIH0gZWxzZSBpZiAoaG91ciA9PSBjdXJyZW50VGltZUFycmF5WzBdKXtcbiAgICAgICAgaWYobWluIDw9IGN1cnJlbnRUaW1lQXJyYXlbMV0pXG4gICAgICAgIHtcbiAgICAgICAgICBkYXRhLmFkZFJvd3MoW1xuICAgICAgICAgICAgICBbXG4gICAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICAgIHRpbWUsIFxuICAgICAgICAgICAgICAgICAgc3RvcmVEYXRhW3N0b3JlXVsnaGlzdG9yeSddWzBdWyd0aW1lcyddW2ktMV1bJ29jY3VwYW5jeSddKjEwMCwgXG4gICAgICAgICAgICAgICAgICBzdG9yZURhdGFbc3RvcmVdWydoaXN0b3J5J11bMF1bJ3RpbWVzJ11baS0xXVsnbm9pc2UnXSoxMDAsXG4gICAgICAgICAgICAgICAgICBzdG9yZURhdGFbc3RvcmVdWydoaXN0b3J5J11bMF1bJ3RpbWVzJ11baS0xXVsnaHVtaWRpdHknXSoxMDAsXG4gICAgICAgICAgICAgICAgICBudWxsLFxuICAgICAgICAgICAgICAgICAgbnVsbCxcbiAgICAgICAgICAgICAgICAgIG51bGxcbiAgICAgICAgICAgICAgXVxuICAgICAgICAgIF1cbiAgICAgICAgICApO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIGRhdGEuYWRkUm93cyhbXG4gICAgICAgICAgICAgIFtcbiAgICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgICAgdGltZSwgXG4gICAgICAgICAgICAgICAgICBudWxsLCBcbiAgICAgICAgICAgICAgICAgIG51bGwsXG4gICAgICAgICAgICAgICAgICBudWxsLFxuICAgICAgICAgICAgICAgICAgc3RvcmVEYXRhW3N0b3JlXVsnaGlzdG9yeSddWzBdWyd0aW1lcyddW2ktMV1bJ29jY3VwYW5jeSddKjEwMCwgXG4gICAgICAgICAgICAgICAgICBzdG9yZURhdGFbc3RvcmVdWydoaXN0b3J5J11bMF1bJ3RpbWVzJ11baS0xXVsnbm9pc2UnXSoxMDAsXG4gICAgICAgICAgICAgICAgICBzdG9yZURhdGFbc3RvcmVdWydoaXN0b3J5J11bMF1bJ3RpbWVzJ11baS0xXVsnaHVtaWRpdHknXSoxMDBcbiAgICAgICAgICAgICAgXVxuICAgICAgICAgIF1cbiAgICAgICAgICApO1xuICAgICAgICB9XG4gICAgICB9ZWxzZSB7XG4gICAgICAgIGRhdGEuYWRkUm93cyhbXG4gICAgICAgICAgICAgIFtcbiAgICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgICAgdGltZSwgXG4gICAgICAgICAgICAgICAgICBudWxsLCBcbiAgICAgICAgICAgICAgICAgIG51bGwsXG4gICAgICAgICAgICAgICAgICBudWxsLFxuICAgICAgICAgICAgICAgICAgc3RvcmVEYXRhW3N0b3JlXVsnaGlzdG9yeSddWzBdWyd0aW1lcyddW2ktMV1bJ29jY3VwYW5jeSddKjEwMCwgXG4gICAgICAgICAgICAgICAgICBzdG9yZURhdGFbc3RvcmVdWydoaXN0b3J5J11bMF1bJ3RpbWVzJ11baS0xXVsnbm9pc2UnXSoxMDAsXG4gICAgICAgICAgICAgICAgICBzdG9yZURhdGFbc3RvcmVdWydoaXN0b3J5J11bMF1bJ3RpbWVzJ11baS0xXVsnaHVtaWRpdHknXSoxMDBcbiAgICAgICAgICAgICAgXVxuICAgICAgICAgIF1cbiAgICAgICAgICApO1xuICAgICAgfVxuICAgIH1cblxuXG4gICAgICB2YXIgb3B0aW9ucyA9IHtcbiAgICAgICAgaEF4aXM6IHsgXG4gICAgICAgICAgc2hvd1RleHRFdmVyeSA6ICc0JyxcbiAgICAgICAgICBncmlkbGluZXMgOntjb3VudDogJzEwJ31cbiAgICAgICAgfSxcbiAgICAgICAgdkF4aXM6IHtcbiAgICAgICAgICBiYXNlbGluZTogMFxuICAgICAgICB9LFxuICAgICAgICBjdXJ2ZVR5cGU6ICdmdW5jdGlvbicsXG4gICAgICAgIHdpZHRoOiAnNzAwJyxcbiAgICAgICAgbGVnZW5kOiB7IHBvc2l0aW9uOiAnYm90dG9tJyB9XG4gICAgICB9O1xuXG4gICAgdmFyIGNoYXJ0X2RpdiA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdjaGFydF9kaXYnKTtcbiAgICB2YXIgY2hhcnQgPSBuZXcgZ29vZ2xlLnZpc3VhbGl6YXRpb24uTGluZUNoYXJ0KGNoYXJ0X2Rpdik7XG5cbiAgICAvLyBXYWl0IGZvciB0aGUgY2hhcnQgdG8gZmluaXNoIGRyYXdpbmcgYmVmb3JlIGNhbGxpbmcgdGhlIGdldEltYWdlVVJJKCkgbWV0aG9kLlxuICAgIGdvb2dsZS52aXN1YWxpemF0aW9uLmV2ZW50cy5hZGRMaXN0ZW5lcihjaGFydCwgJ3JlYWR5JywgZnVuY3Rpb24gKCkgeyB9KTtcblxuICAgIGNoYXJ0LmRyYXcoZGF0YSwgb3B0aW9ucyk7XG4gICAgcmV0dXJuKCc8aW1nIHNyYz1cIicgKyBjaGFydC5nZXRJbWFnZVVSSSgpICsgJ1wiPicpO1xufSIsIiAgICB2YXIgZ3JvdW5kRmxvb3I7XG4gICAgdmFyIGdyb3VuZEZsb29yUmVxVVJMID0gJ2FwaS9ncm91bmRGbG9vclN0b3Jlcy5qc29uJztcbiAgICB2YXIgZ3JvdW5kRmxvb3JSZXEgPSBuZXcgWE1MSHR0cFJlcXVlc3QoKTtcbiAgICBncm91bmRGbG9vclJlcS5vcGVuKCdHRVQnLCBncm91bmRGbG9vclJlcVVSTCk7XG4gICAgZ3JvdW5kRmxvb3JSZXEuc2VuZCgpO1xuICAgIGdyb3VuZEZsb29yUmVxLm9ubG9hZCA9ICgpID0+IHtcbiAgICAgICAgdmFyIGdyb3VuZEZsb29yU3RvcmVzID0gZ3JvdW5kRmxvb3JSZXEucmVzcG9uc2U7XG4gICAgICAgIHZhciBvYmogPSBKU09OLnBhcnNlKGdyb3VuZEZsb29yU3RvcmVzKTtcbiAgICAgICAgZ3JvdW5kRmxvb3IgPSBvYmo7XG4gICAgfVxuXG4gICAgdmFyIGZpcnN0Rmxvb3I7XG4gICAgdmFyIGZpcnN0Rmxvb3JSZXFVUkwgPSAnYXBpL2ZpcnN0Rmxvb3JTdG9yZXMuanNvbic7XG4gICAgdmFyIGZpcnN0Rmxvb3JSZXEgPSBuZXcgWE1MSHR0cFJlcXVlc3QoKTtcbiAgICBmaXJzdEZsb29yUmVxLm9wZW4oJ0dFVCcsIGZpcnN0Rmxvb3JSZXFVUkwpO1xuICAgIGZpcnN0Rmxvb3JSZXEuc2VuZCgpO1xuICAgIGZpcnN0Rmxvb3JSZXEub25sb2FkID0gKCkgPT4ge1xuICAgICAgICB2YXIgZmlyc3RGbG9vclN0b3JlcyA9IGZpcnN0Rmxvb3JSZXEucmVzcG9uc2U7XG4gICAgICAgIHZhciBvYmogPSBKU09OLnBhcnNlKGZpcnN0Rmxvb3JTdG9yZXMpO1xuICAgICAgICBmaXJzdEZsb29yID0gb2JqO1xuICAgIH1cblxuICAgIHZhciBzdG9yZURhdGE7XG4gICAgdmFyIHN0b3JlUmVxVVJMID0gJ2FwaS9kYXRhLmpzb24nO1xuICAgIHZhciBzdG9yZVJlcSA9IG5ldyBYTUxIdHRwUmVxdWVzdCgpO1xuICAgIHN0b3JlUmVxLm9wZW4oJ0dFVCcsIHN0b3JlUmVxVVJMKTtcbiAgICBzdG9yZVJlcS5zZW5kKCk7XG4gICAgc3RvcmVSZXEub25sb2FkID0gKCkgPT4ge1xuICAgICAgICB2YXIgc3RvcmVEYXRhcyA9IHN0b3JlUmVxLnJlc3BvbnNlO1xuICAgICAgICB2YXIgb2JqID0gSlNPTi5wYXJzZShzdG9yZURhdGFzKTtcbiAgICAgICAgc3RvcmVEYXRhID0gb2JqO1xuICAgIH1cbiIsInZhciBncm91bmRGbG9vcjtcbnZhciBncm91bmRGbG9vclJlcVVSTCA9ICdhcGkvZ3JvdW5kRmxvb3JTdG9yZXMuanNvbic7XG52YXIgZ3JvdW5kRmxvb3JSZXEgPSBuZXcgWE1MSHR0cFJlcXVlc3QoKTtcbmdyb3VuZEZsb29yUmVxLm9wZW4oJ0dFVCcsIGdyb3VuZEZsb29yUmVxVVJMKTtcbmdyb3VuZEZsb29yUmVxLnNlbmQoKTtcbmdyb3VuZEZsb29yUmVxLm9ubG9hZCA9ICgpID0+IHtcbiAgICB2YXIgZ3JvdW5kRmxvb3JTdG9yZXMgPSBncm91bmRGbG9vclJlcS5yZXNwb25zZTtcbiAgICB2YXIgb2JqID0gSlNPTi5wYXJzZShncm91bmRGbG9vclN0b3Jlcyk7XG4gICAgZ3JvdW5kRmxvb3IgPSBvYmo7XG59XG5cbnZhciBmaXJzdEZsb29yO1xudmFyIGZpcnN0Rmxvb3JSZXFVUkwgPSAnYXBpL2ZpcnN0Rmxvb3JTdG9yZXMuanNvbic7XG52YXIgZmlyc3RGbG9vclJlcSA9IG5ldyBYTUxIdHRwUmVxdWVzdCgpO1xuZmlyc3RGbG9vclJlcS5vcGVuKCdHRVQnLCBmaXJzdEZsb29yUmVxVVJMKTtcbmZpcnN0Rmxvb3JSZXEuc2VuZCgpO1xuZmlyc3RGbG9vclJlcS5vbmxvYWQgPSAoKSA9PiB7XG4gICAgdmFyIGZpcnN0Rmxvb3JTdG9yZXMgPSBmaXJzdEZsb29yUmVxLnJlc3BvbnNlO1xuICAgIHZhciBvYmogPSBKU09OLnBhcnNlKGZpcnN0Rmxvb3JTdG9yZXMpO1xuICAgIGZpcnN0Rmxvb3IgPSBvYmo7XG59XG5cbnZhciBzdG9yZURhdGE7XG52YXIgc3RvcmVSZXFVUkwgPSAnYXBpL2RhdGEuanNvbic7XG52YXIgc3RvcmVSZXEgPSBuZXcgWE1MSHR0cFJlcXVlc3QoKTtcbnN0b3JlUmVxLm9wZW4oJ0dFVCcsIHN0b3JlUmVxVVJMKTtcbnN0b3JlUmVxLnNlbmQoKTtcbnN0b3JlUmVxLm9ubG9hZCA9ICgpID0+IHtcbiAgICB2YXIgc3RvcmVEYXRhcyA9IHN0b3JlUmVxLnJlc3BvbnNlO1xuICAgIHZhciBvYmogPSBKU09OLnBhcnNlKHN0b3JlRGF0YXMpO1xuICAgIHN0b3JlRGF0YSA9IG9iajtcbn1cblxuXG5mdW5jdGlvbiBzZXRFbnRpdHlIaWdobGlnaHRzKCkge1xuICAgIGZvcih2YXIgaSA9IDA7IGkgPCBncm91bmRGbG9vci5zdG9yZXMubGVuZ3RoOyBpKyspe1xuICAgICAgICBtYXAuaW5kb29ycy5zZXRFbnRpdHlIaWdobGlnaHRzKGdyb3VuZEZsb29yLnN0b3Jlc1tpXS5pZC50b1N0cmluZygpLCByYW5kb21Db2xvcigpKTtcbiAgICB9XG4gICAgZm9yKHZhciBpID0gMDsgaSA8IGZpcnN0Rmxvb3Iuc3RvcmVzLmxlbmd0aDsgaSsrKXtcbiAgICAgICAgbWFwLmluZG9vcnMuc2V0RW50aXR5SGlnaGxpZ2h0cyhmaXJzdEZsb29yLnN0b3Jlc1tpXS5pZC50b1N0cmluZygpLCByYW5kb21Db2xvcigpKTtcbiAgICB9XG59XG5cbmZ1bmN0aW9uIHJhbmRvbUNvbG9yKCl7XG4gICAgdmFyIHJlZCA9IE1hdGguZmxvb3IoTWF0aC5yYW5kb20oKSAqIDI1Nik7XG4gICAgdmFyIGdyZWVuID0gMjU1IC0gcmVkO1xuICAgIHJldHVybiBbcmVkLCBncmVlbiwgMCwgMjAwXVxufVxuXG5mdW5jdGlvbiBjbGVhckVudGl0eUhpZ2hsaWdodHMoKSB7XG4gICAgbWFwLmluZG9vcnMuY2xlYXJFbnRpdHlIaWdobGlnaHRzKCk7XG59XG5cbnZhciBkID0gbmV3IERhdGUoKTtcbiIsInZhciBtYXAgPSBMLldybGQubWFwKFwibWFwXCIsIFwiOWQ4NzY2NDZmN2Q4M2NjNzA5ZWRiZTIwNGM4MWQ1NDZcIiwge1xuICAgIGNlbnRlcjogWzU2LjQ1OTgsIC0yLjk3MjhdLFxuICAgIHpvb206IDE3LFxuICAgIGluZG9vcnNFbmFibGVkOiB0cnVlXG4gIH0pO1xuICB2YXIgaW5kb29yQ29udHJvbCA9IG5ldyBXcmxkSW5kb29yQ29udHJvbChcIndpZGdldC1jb250YWluZXJcIiwgbWFwKTtcbiAgdmFyIGN1cnJlbnRJbmRvb3JNYXBJZDtcbiAgdmFyIGN1cnJlbnRGbG9vcjtcbiAgdmFyIGVudGl0eUlkc1RvUG9zaXRpb24gPSB7fTtcbiAgdmFyIGQ7XG4gIHZhciBwb3B1cDtcbiAgXG4gIHZhciBsYXN0TW91c2VEb3duO1xuICBmdW5jdGlvbiBvbk1vdXNlRG93bihldmVudCkge1xuICAgIGxhc3RNb3VzZURvd24gPSBldmVudC5sYXRsbmc7XG4gIH1cbiAgXG4gIGZ1bmN0aW9uIG9uSW5kb29yRW50aXR5Q2xpY2tlZChldmVudCkge1xuICAgIGV2ZW50Lmlkcy5mb3JFYWNoKGlkZW50aWZ5RW50aXR5KTtcbiAgfVxuXG4gIGZ1bmN0aW9uIGV4cG9ydElkTWFwKCkge1xuICAgIGNvbnNvbGUubG9nKEpTT04uc3RyaW5naWZ5KGVudGl0eUlkc1RvUG9zaXRpb24pKTtcbiAgfVxuICBcbiAgZnVuY3Rpb24gb25JbmRvb3JNYXBFbnRlcmVkKGV2ZW50KSB7XG4gICAgbWFwLmluZG9vcnMuc2V0Rmxvb3IoMCk7XG4gICAgbWFwLnNldFZpZXcoWzU2LjQ1OTgsIC0yLjk3MjhdLCAxNyk7XG4gICAgY3VycmVudEluZG9vck1hcElkID0gZXZlbnQuaW5kb29yTWFwLmdldEluZG9vck1hcElkKCk7XG4gICAgY3VycmVudEZsb29yID0gbWFwLmluZG9vcnMuZ2V0Rmxvb3IoKS5nZXRGbG9vckluZGV4KCk7XG4gIH1cbiAgXG4gIGZ1bmN0aW9uIG9uSW5kb29yTWFwRmxvb3JDaGFuZ2VkKCkge1xuICAgIGN1cnJlbnRGbG9vciA9IG1hcC5pbmRvb3JzLmdldEZsb29yKCkuZ2V0Rmxvb3JJbmRleCgpO1xuICB9XG5cbiAgZnVuY3Rpb24gZ2V0U3RvcmVOYW1lKGlkKXtcbiAgICBpZihjdXJyZW50Rmxvb3IgPT0gMClcbiAgICB7XG4gICAgICBmb3IodmFyIGkgPSAwOyBpIDwgZ3JvdW5kRmxvb3Iuc3RvcmVzLmxlbmd0aDsgaSsrKVxuICAgICAge1xuICAgICAgICBpZihncm91bmRGbG9vci5zdG9yZXNbaV0uaWQgPT0gaWQpXG4gICAgICAgIHtcbiAgICAgICAgICAvL2NvbnNvbGUubG9nKGdyb3VuZEZsb29yLnN0b3Jlc1tpXS5zdG9yZSk7XG4gICAgICAgICAgcmV0dXJuIGdyb3VuZEZsb29yLnN0b3Jlc1tpXS5zdG9yZTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIGZ1bmN0aW9uIHZhbGlkSWQoaWQpIHtcblxuICAgIGZvciggdmFyIGkgPSAwOyBpIDwgZ3JvdW5kRmxvb3Iuc3RvcmVzLmxlbmd0aDsgaSsrKVxuICAgIHtcbiAgICAgICAgICBpZiAoc3RvcmVEYXRhW2ldWydpZCddID09IGlkKVxuICAgICAgICAgIHtcbiAgICAgICAgICAgICAgcmV0dXJuIGk7XG4gICAgICAgICAgfVxuICAgIH1cbiAgICBmb3IoIHZhciBpID0gMDsgaSA8IGZpcnN0Rmxvb3Iuc3RvcmVzLmxlbmd0aDsgaSsrKVxuICAgIHtcbiAgICAgICAgICBpZiAoc3RvcmVEYXRhW2ldWydpZCddID09IGlkKVxuICAgICAgICAgIHtcbiAgICAgICAgICAgICAgcmV0dXJuIGk7XG4gICAgICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gbnVsbDtcbn1cbiAgXG4gIGZ1bmN0aW9uIGlkZW50aWZ5RW50aXR5KGlkKSB7XG4gICAgdmFyIGxhdExuZyA9IGxhc3RNb3VzZURvd247XG4gICAgZCA9IG5ldyBEYXRlKCk7XG5cbiAgICB2YXIgdmFsaWQgPSB2YWxpZElkKGlkKTtcblxuICAgIGlmKHZhbGlkICE9IG51bGwpXG4gICAge1xuICAgICAgbWFwLnNldFZpZXcobGF0TG5nLCAxNyk7XG4gICAgICBcbiAgICAgIHZhciBwb3B1cE9wdGlvbnMgPSB7IFxuICAgICAgICBpbmRvb3JNYXBJZDogY3VycmVudEluZG9vck1hcElkLCBcbiAgICAgICAgaW5kb29yTWFwRmxvb3JJbmRleDogY3VycmVudEZsb29yLCBcbiAgICAgICAgYXV0b0Nsb3NlOiB0cnVlLCBcbiAgICAgICAgY2xvc2VPbkNsaWNrOiB0cnVlLFxuICAgICAgICBtaW5XaWR0aDogXCI3MDBcIiAgICAgICAgICBcbiAgICAgIH07XG4gICAgICBwb3B1cCA9IEwucG9wdXAocG9wdXBPcHRpb25zKVxuICAgICAgICAuc2V0TGF0TG5nKGxhdExuZylcbiAgICAgICAgLmFkZFRvKG1hcClcbiAgICAgICAgLnNldENvbnRlbnQoY3JlYXRlTW9ja0hUTUxFbGVtZW50KGlkLCBkLCBkcmF3QmFzaWMoaWQpKSk7XG4gICAgICBlbnRpdHlJZHNUb1Bvc2l0aW9uW2lkXSA9IHsgXCJsYXRMbmdcIjogbGF0TG5nLCBcImluZG9vcklkXCI6IGN1cnJlbnRJbmRvb3JNYXBJZCwgXCJmbG9vckluZGV4XCI6IGN1cnJlbnRGbG9vciB9IDtcbiAgICB9XG5cbiAgICBzZXRUaW1lb3V0KHVwZGF0ZVBvcHVwKGlkLCBkKSwgNTAwMCk7XG4gIH1cblxuICBmdW5jdGlvbiB1cGRhdGVQb3B1cChpZCwgZClcbiAge1xuICAgIGQgPSBuZXcgRGF0ZSgpO1xuICAgIGNvbnNvbGUubG9nKGQudG9Mb2NhbGVUaW1lU3RyaW5nKCdpdC1JVCcpKTtcbiAgICBwb3B1cC5zZXRDb250ZW50KGNyZWF0ZU1vY2tIVE1MRWxlbWVudChpZCwgZCwgZHJhd0Jhc2ljKGlkKSkpO1xuICB9XG5cbiAgbWFwLmluZG9vcnMub24oXCJpbmRvb3JtYXBlbnRlclwiLCBvbkluZG9vck1hcEVudGVyZWQpO1xuICBtYXAuaW5kb29ycy5vbihcImluZG9vcm1hcGZsb29yY2hhbmdlXCIsIG9uSW5kb29yTWFwRmxvb3JDaGFuZ2VkKVxuICBtYXAuaW5kb29ycy5vbihcImluZG9vcmVudGl0eWNsaWNrXCIsIG9uSW5kb29yRW50aXR5Q2xpY2tlZCk7XG4gIG1hcC5vbihcIm1vdXNlZG93blwiLCBvbk1vdXNlRG93bik7XG5cbiAgZnVuY3Rpb24gY3JlYXRlTW9ja0hUTUxFbGVtZW50KGlkLCBkYXRlLCBncmFwaFRleHQpe1xuICAgIHZhciBncmFwaEhUTUwgPSAnPGRpdiBjbGFzcz1cImNvbnRlbnRcIj4nICtcbiAgICAgICAgICAgICAgICAgICAgJzxoMj4nKyBnZXRTdG9yZU5hbWUoaWQpICsgICcgJyArIGQudG9Mb2NhbGVUaW1lU3RyaW5nKCdpdC1JVCcpICtcbiAgICAgICAgICAgICAgICAgICAgZ3JhcGhUZXh0ICtcbiAgICAgICAgICAgICAgICAgICAgJzwvZGl2Pic7XG4gICAgcmV0dXJuIGdyYXBoSFRNTDtcbn1cblxuXG5cblxuXG4vKiAgICAgICAgICAgICAgICAgICc8ZGl2IGNsYXNzPVwiY29udGVudFwiPicgK1xuICAgICAgICAgICAgICAgICAgICAnPGgyPicrIGdldFN0b3JlTmFtZShpZCkgKyAnIGZvciB0aGUgJyArIGQuZ2V0RGF0ZSgpICsgJyBvZiBTcGV0ZW1iZXIgMjAxODwvaDI+JyArXG4gICAgICAgICAgICAgICAgICAgIGdyYXBoVGV4dCArXG4gICAgICAgICAgICAgICAgICAgICc8L2Rpdj4nO1xuKi9cblxuXG5cbiIsIi8vIHZhciBkID0gbmV3IERhdGUoKTtcbi8vIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKFwiZGF0ZVwiKS5pbm5lckhUTUwgPSBkOyIsIi8vT25sb2FkIGZ1bmN0aW9uIHRvIHNldHVwIHNsaWRlcnNcbndpbmRvdy5vbmxvYWQgPSBmdW5jdGlvbiAoKXtcbiAgICB2YXIgc2xpZGVycyA9IGRvY3VtZW50LmdldEVsZW1lbnRzQnlDbGFzc05hbWUoXCJyYW5nZVBpY2tlclwiKTtcbiAgICAvLyB2YXIgdGV4dEJveGVzID0gZG9jdW1lbnQuZ2V0RWxlbWVudHNCeUNsYXNzTmFtZShcInRleHRCb3hcIik7XG4gICAgW10uZm9yRWFjaC5jYWxsKHNsaWRlcnMsIGZ1bmN0aW9uIChzbGlkZXIpIHsgICAgXG4gICAgICAgIHNsaWRlci5taW4gPSAxMDtcbiAgICAgICAgc2xpZGVyLm1heCA9IDUwO1xuICAgICAgICBzbGlkZXIuc3RlcCA9IDEwO1xuICAgICAgICBzbGlkZXIudmFsdWUgPSAzMDtcbiAgICB9KTtcblxuICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKFwiU0FEXCIpLmFkZEV2ZW50TGlzdGVuZXIoXCJjbGlja1wiLCBwcmVzZXRzVXBkYXRlKDApKTtcbiAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChcIkdPT0RcIikuYWRkRXZlbnRMaXN0ZW5lcihcImNsaWNrXCIsIHByZXNldHNVcGRhdGUoMikpO1xuICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKFwiTk9STUFMXCIpLmFkZEV2ZW50TGlzdGVuZXIoXCJjbGlja1wiLCBwcmVzZXRzVXBkYXRlKDEpKTtcbn1cblxuZnVuY3Rpb24gcHJlc2V0c1VwZGF0ZShsZXZlbCl7XG4gICAgdmFyIG9jY3VwYW5jeSA9IFsxMCwzMCw1MF07XG4gICAgdmFyIG5vaXNlID0gWzEwLDMwLDUwXTtcbiAgICB2YXIgaHVtaWRpdHkgPSBbMTAsMzAsNTBdO1xuXG4gICAgZm9yKHZhciBpPTA7IGkgPCAzOyBpKyspe1xuICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChcIm9jY3VwYW5jeS1zbGlkZXJcIikudmFsdWUgPSBvY2N1cGFuY3lbbGV2ZWxdO1xuICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChcIm5vaXNlLXNsaWRlclwiKS52YWx1ZSA9IG5vaXNlW2xldmVsXTtcbiAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoXCJodW1pZGl0eS1zbGlkZXJcIikudmFsdWUgPSBodW1pZGl0eVtsZXZlbF07XG4gICAgfVxufSJdfQ==
