google.charts.load('current', {packages: ['corechart', 'line']});
google.charts.setOnLoadCallback(drawBasic);


    // var groundFloor;
    // var groundFloorReqURL = 'api/groundFloorStores.json';
    // var groundFloorReq = new XMLHttpRequest();
    // groundFloorReq.open('GET', groundFloorReqURL);
    // groundFloorReq.send();
    // groundFloorReq.onload = () => {
    //     var groundFloorStores = groundFloorReq.response;
    //     var obj = JSON.parse(groundFloorStores);
    //     groundFloor = obj;
    // }

    // var firstFloor;
    // var firstFloorReqURL = 'api/firstFloorStores.json';
    // var firstFloorReq = new XMLHttpRequest();
    // firstFloorReq.open('GET', firstFloorReqURL);
    // firstFloorReq.send();
    // firstFloorReq.onload = () => {
    //     var firstFloorStores = firstFloorReq.response;
    //     var obj = JSON.parse(firstFloorStores);
    //     firstFloor = obj;
    // }

    // var storeData;
    // var storeReqURL = 'api/data.json';
    // var storeReq = new XMLHttpRequest();
    // storeReq.open('GET', storeReqURL);
    // storeReq.send();
    // storeReq.onload = () => {
    //     var storeDatas = storeReq.response;
    //     var obj = JSON.parse(storeDatas);
    //     storeData = obj;
    // }

function drawBasic(id) {

    var store;

    for( var i = 0; i < groundFloor.stores.length; i++)
    {
        if (storeData[i]['id'] == id)
        {
            store = i;
            break;
        }
    }
    for( var i = 0; i < firstFloor.stores.length; i++)
    {
        if (storeData[i]['id'] == id)
        {
            store = i;
            break;
        }
    }

    var data = new google.visualization.DataTable();

    data.addColumn('string', 'Time');
    data.addColumn('number', 'Occupancy');
    data.addColumn('number', 'Noise');
    data.addColumn('number', 'Humidity');


    for( var i = 1; i < 41; i++)
    {

      var timeslot = storeData[store]['history'][0]['times'][i-1]['timeslot'].toString();
      var timeslotArray = timeslot.split('');
      
      var hour = timeslotArray[11].concat(timeslotArray[12]);
      var min = timeslotArray[14].concat(timeslotArray[15]);
      var time = hour.concat(min);




      data.addRows([
          [
              
              time, 
              storeData[store]['history'][0]['times'][i-1]['occupancy']*100, 
              storeData[store]['history'][0]['times'][i-1]['noise']*100,
              storeData[store]['history'][0]['times'][i-1]['humidity']*100
          ]
      ]
      );

    }


      var options = {
        hAxis: { 
          showTextEvery : '4',
          gridlines :{count: '10'}
        },
        vAxis: {
          baseline: 0
        },
        curveType: 'function',
        width: '700',
        legend: { position: 'bottom' }
      };

    var chart_div = document.getElementById('chart_div');
    var chart = new google.visualization.LineChart(chart_div);

    // Wait for the chart to finish drawing before calling the getImageURI() method.
    google.visualization.events.addListener(chart, 'ready', function () { });

    chart.draw(data, options);
    return('<img src="' + chart.getImageURI() + '">');
}

    var groundFloor;
    var groundFloorReqURL = 'api/groundFloorStores.json';
    var groundFloorReq = new XMLHttpRequest();
    groundFloorReq.open('GET', groundFloorReqURL);
    groundFloorReq.send();
    groundFloorReq.onload = () => {
        var groundFloorStores = groundFloorReq.response;
        var obj = JSON.parse(groundFloorStores);
        groundFloor = obj;
    }

    var firstFloor;
    var firstFloorReqURL = 'api/firstFloorStores.json';
    var firstFloorReq = new XMLHttpRequest();
    firstFloorReq.open('GET', firstFloorReqURL);
    firstFloorReq.send();
    firstFloorReq.onload = () => {
        var firstFloorStores = firstFloorReq.response;
        var obj = JSON.parse(firstFloorStores);
        firstFloor = obj;
    }

    var storeData;
    var storeReqURL = 'api/data.json';
    var storeReq = new XMLHttpRequest();
    storeReq.open('GET', storeReqURL);
    storeReq.send();
    storeReq.onload = () => {
        var storeDatas = storeReq.response;
        var obj = JSON.parse(storeDatas);
        storeData = obj;
    }

function setEntityHighlights() {
    for(var i = 0; i < groundFloor.stores.length; i++){
        map.indoors.setEntityHighlights(groundFloor.stores[i].id.toString(), randomColor());
    }
    for(var i = 0; i < firstFloor.stores.length; i++){
        map.indoors.setEntityHighlights(firstFloor.stores[i].id.toString(), randomColor());
    }

}
function setStoreHighlights(store, colour){
    store = store.toString();
    map.indoors.setEntityHighlights(store, colour);
}

function randomColor(){
    var red = Math.floor(Math.random() * 256);
    var green = 255 - red;
    return [red, green, 0, 200];
}

function clearEntityHighlights(){
    map.indoors.clearEntityHighlights();
}
var map = L.Wrld.map("map", "9d876646f7d83cc709edbe204c81d546", {
    center: [56.4598, -2.9728],
    zoom: 17,
    indoorsEnabled: true
});
  var indoorControl = new WrldIndoorControl("widget-container", map);
  var currentIndoorMapId;
  var currentFloor;
  var entityIdsToPosition = {};
  
  var lastMouseDown;
  function onMouseDown(event) {
    lastMouseDown = event.latlng;
  }
  
  function onIndoorEntityClicked(event) {
    event.ids.forEach(identifyEntity);
  }

  function exportIdMap() {
    console.log(JSON.stringify(entityIdsToPosition));
  }
  
  function onIndoorMapEntered(event) {
    currentIndoorMapId = event.indoorMap.getIndoorMapId();
    currentFloor = map.indoors.getFloor().getFloorIndex();
  }
  
  function onIndoorMapFloorChanged() {
    currentFloor = map.indoors.getFloor().getFloorIndex();
  }
  
  function identifyEntity(id) {
    var latLng = lastMouseDown;

    var graph = drawBasic(id);
    
    var popupOptions = { 
      indoorMapId: currentIndoorMapId, 
      indoorMapFloorIndex: currentFloor, 
      autoClose: false, 
      closeOnClick: false,
      minWidth: "5"          
    };
    var popup = L.popup(popupOptions)
      .setLatLng(latLng)
      .addTo(map)
      .setContent(graph);
    entityIdsToPosition[id] = { "latLng": latLng, "indoorId": currentIndoorMapId, "floorIndex": currentFloor } ;
  }

  map.indoors.on("indoormapenter", onIndoorMapEntered);
  map.indoors.on("indoormapfloorchange", onIndoorMapFloorChanged)
  map.indoors.on("indoorentityclick", onIndoorEntityClicked);
  map.on("mousedown", onMouseDown);
// var d = new Date();
// document.getElementById("date").innerHTML = d;
//Onload function to setup sliders
window.onload = function (){
    var sliders = document.getElementsByClassName("rangePicker");
    // var textBoxes = document.getElementsByClassName("textBox");
    [].forEach.call(sliders, function (slider) {    
        slider.min = 10;
        slider.max = 50;
        slider.step = 10;
        slider.value = 30;
    });

    document.getElementById("SAD").addEventListener("click", presetsUpdate(0));
    document.getElementById("GOOD").addEventListener("click", presetsUpdate(2));
    document.getElementById("NORMAL").addEventListener("click", presetsUpdate(1));
}

function presetsUpdate(level){
    var occupancy = [10,30,50];
    var noise = [10,30,50];
    var humidity = [10,30,50];

    for(var i=0; i < 3; i++){
        document.getElementById("occupancy-slider").value = occupancy[level];
        document.getElementById("noise-slider").value = noise[level];
        document.getElementById("humidity-slider").value = humidity[level];
    }
}
// Called when a slider is updated. 
function updateMapFromSliders(){ 

    var stores = storeData;
    var current = getCurrentSliderLevel();
    var level = Math.round(getAverageSliderLevel(current));
    var max = getMaxToleranceLevel(level);
    var min = getMinToleranceLevel(level);

    for(var i = 0; i < stores.length; i++){
        var storeID = stores[i].id;
        //var currentData = getCurrentData(storeID, Math.round(level));
        var dataArray = getCurrentTimeslot(storeID);
        console.log(dataArray, i);
        var colour = calculateColour(dataArray, max, min); 

        setStoreHighlights(storeID, colour);
    }

}

// Gets current levels sliders are at, parses them into numbers.
// Returns as an array.
function getCurrentSliderLevel(){
    var sliderArray =[];
    var sliders = document.getElementsByClassName("rangePicker");
    [].forEach.call(sliders, function (slider) {
        sliderArray.push(parseInt(slider.value, 10));
    });
    console.log("Slider Values: " + sliderArray);
    return sliderArray;
}


// Takes an array of numbers (int)
// Returns the average of the array.
// Code for avaraging arrays found via Google at https://gist.github.com/bmorelli25/4564b8ff35b47d8a9db6b0dda1143465
function getAverageSliderLevel(sliderArray){
    const arrAvg = arr => arr.reduce((a,b) => a + b, 0) / arr.length;
    return arrAvg(sliderArray);
};

function getMaxToleranceLevel(sliderAvg){
    var maxTolerable;
    switch(sliderAvg){
        case 1:
        case 2:
            return maxTolerable = 0.4;
            break;
        case 3:
            return maxTolerable = 0.6;
            break;
        case 4:
        case 5:
            return maxTolerable = 0.9;
            break;
    }
}
function getMinToleranceLevel(sliderAvg){
    var minTolerable;

    switch(sliderAvg){
        case 1:
        case 2:
            return minTolerable = 0.1;
            break;
        case 3:
            return minTolerable = 0.3;
            break;
        case 4:
        case 5:
            return minTolerable = 0.6;
            break;
    }
}
// parseDataObj(obj);
//     obj
//     currentDataArray = [];
//     currentArray.push(currentTimeslot['occupancy']);
//     currentArray.push(currentTimeslot['noise']);
//     currentArray.push(currentTimeslot['humidity']);

//     return calculateColour(currentArray, maxTolerable, minTolerable);
// }

function getCurrentTimeslot(id){
    var store;
    for( var i = 0; i < groundFloor.stores.length; i++) {
        if (storeData[i]['id'] == id) {
            store = i;
            break;
        }
    }
    return storeData[store]['history'][0]['times'][0];
}

function checkValue(value, max, min){
    var colourLevel = 0;
    if(parseFloat(value) > max){ colourLevel = 5; };
    if(parseFloat(value) < min){ colourLevel = 1; };
    if(parseFloat(value) < max && parseFloat(value > min)){ colourLevel = 3; };
    console.log("Value Being Checked: " + parseFloat(value) + " Colour Level" + colourLevel);
    return parseInt(colourLevel);
}

function calculateColour(currentDataObj, max, min){
    var colourLevel = 0;
    var colour;
    var occupancy = currentDataObj.occupancy;
    var noise = currentDataObj.noise;
    var humidity = currentDataObj.humidity;
    console.log("Occupany~Noise~Humidity: " + occupancy + " " + noise + " " + humidity)
    colourLevel += checkValue(occupancy,max,min);
    colourLevel += checkValue(noise, max, min);
    colourLevel += checkValue(humidity, max, min);
    
    var avgColourLevel = Math.round(colourLevel / 3);
    console.log(avgColourLevel);
    switch(avgColourLevel){
        case 1:
        case 2:
            colour = [255,0,0,200];
            break;
        case 3:
            colour = [255,140,0,200];
            break;
        case 4:
        case 5:
            colour = [0,255,0,200];
            break;
        default: 
            colour= [255,255,200, 200];
    }
    return colour;
}

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImdyYXBoLmpzIiwibG9hZERhdGEuanMiLCJtYXBIaWdobGlnaHRpbmcuanMiLCJwb3B1cHMuanMiLCJyZWFsVGltZUdyYXBoLmpzIiwic2V0dGluZ3MuanMiLCJzbGlkZXJzLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUNuSEE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FDaENBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUN0QkE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUN0REE7QUFDQTtBQ0RBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQzFCQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSIsImZpbGUiOiJhcHAubWluLmpzIiwic291cmNlc0NvbnRlbnQiOlsiZ29vZ2xlLmNoYXJ0cy5sb2FkKCdjdXJyZW50Jywge3BhY2thZ2VzOiBbJ2NvcmVjaGFydCcsICdsaW5lJ119KTtcbmdvb2dsZS5jaGFydHMuc2V0T25Mb2FkQ2FsbGJhY2soZHJhd0Jhc2ljKTtcblxuXG4gICAgLy8gdmFyIGdyb3VuZEZsb29yO1xuICAgIC8vIHZhciBncm91bmRGbG9vclJlcVVSTCA9ICdhcGkvZ3JvdW5kRmxvb3JTdG9yZXMuanNvbic7XG4gICAgLy8gdmFyIGdyb3VuZEZsb29yUmVxID0gbmV3IFhNTEh0dHBSZXF1ZXN0KCk7XG4gICAgLy8gZ3JvdW5kRmxvb3JSZXEub3BlbignR0VUJywgZ3JvdW5kRmxvb3JSZXFVUkwpO1xuICAgIC8vIGdyb3VuZEZsb29yUmVxLnNlbmQoKTtcbiAgICAvLyBncm91bmRGbG9vclJlcS5vbmxvYWQgPSAoKSA9PiB7XG4gICAgLy8gICAgIHZhciBncm91bmRGbG9vclN0b3JlcyA9IGdyb3VuZEZsb29yUmVxLnJlc3BvbnNlO1xuICAgIC8vICAgICB2YXIgb2JqID0gSlNPTi5wYXJzZShncm91bmRGbG9vclN0b3Jlcyk7XG4gICAgLy8gICAgIGdyb3VuZEZsb29yID0gb2JqO1xuICAgIC8vIH1cblxuICAgIC8vIHZhciBmaXJzdEZsb29yO1xuICAgIC8vIHZhciBmaXJzdEZsb29yUmVxVVJMID0gJ2FwaS9maXJzdEZsb29yU3RvcmVzLmpzb24nO1xuICAgIC8vIHZhciBmaXJzdEZsb29yUmVxID0gbmV3IFhNTEh0dHBSZXF1ZXN0KCk7XG4gICAgLy8gZmlyc3RGbG9vclJlcS5vcGVuKCdHRVQnLCBmaXJzdEZsb29yUmVxVVJMKTtcbiAgICAvLyBmaXJzdEZsb29yUmVxLnNlbmQoKTtcbiAgICAvLyBmaXJzdEZsb29yUmVxLm9ubG9hZCA9ICgpID0+IHtcbiAgICAvLyAgICAgdmFyIGZpcnN0Rmxvb3JTdG9yZXMgPSBmaXJzdEZsb29yUmVxLnJlc3BvbnNlO1xuICAgIC8vICAgICB2YXIgb2JqID0gSlNPTi5wYXJzZShmaXJzdEZsb29yU3RvcmVzKTtcbiAgICAvLyAgICAgZmlyc3RGbG9vciA9IG9iajtcbiAgICAvLyB9XG5cbiAgICAvLyB2YXIgc3RvcmVEYXRhO1xuICAgIC8vIHZhciBzdG9yZVJlcVVSTCA9ICdhcGkvZGF0YS5qc29uJztcbiAgICAvLyB2YXIgc3RvcmVSZXEgPSBuZXcgWE1MSHR0cFJlcXVlc3QoKTtcbiAgICAvLyBzdG9yZVJlcS5vcGVuKCdHRVQnLCBzdG9yZVJlcVVSTCk7XG4gICAgLy8gc3RvcmVSZXEuc2VuZCgpO1xuICAgIC8vIHN0b3JlUmVxLm9ubG9hZCA9ICgpID0+IHtcbiAgICAvLyAgICAgdmFyIHN0b3JlRGF0YXMgPSBzdG9yZVJlcS5yZXNwb25zZTtcbiAgICAvLyAgICAgdmFyIG9iaiA9IEpTT04ucGFyc2Uoc3RvcmVEYXRhcyk7XG4gICAgLy8gICAgIHN0b3JlRGF0YSA9IG9iajtcbiAgICAvLyB9XG5cbmZ1bmN0aW9uIGRyYXdCYXNpYyhpZCkge1xuXG4gICAgdmFyIHN0b3JlO1xuXG4gICAgZm9yKCB2YXIgaSA9IDA7IGkgPCBncm91bmRGbG9vci5zdG9yZXMubGVuZ3RoOyBpKyspXG4gICAge1xuICAgICAgICBpZiAoc3RvcmVEYXRhW2ldWydpZCddID09IGlkKVxuICAgICAgICB7XG4gICAgICAgICAgICBzdG9yZSA9IGk7XG4gICAgICAgICAgICBicmVhaztcbiAgICAgICAgfVxuICAgIH1cbiAgICBmb3IoIHZhciBpID0gMDsgaSA8IGZpcnN0Rmxvb3Iuc3RvcmVzLmxlbmd0aDsgaSsrKVxuICAgIHtcbiAgICAgICAgaWYgKHN0b3JlRGF0YVtpXVsnaWQnXSA9PSBpZClcbiAgICAgICAge1xuICAgICAgICAgICAgc3RvcmUgPSBpO1xuICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICB2YXIgZGF0YSA9IG5ldyBnb29nbGUudmlzdWFsaXphdGlvbi5EYXRhVGFibGUoKTtcblxuICAgIGRhdGEuYWRkQ29sdW1uKCdzdHJpbmcnLCAnVGltZScpO1xuICAgIGRhdGEuYWRkQ29sdW1uKCdudW1iZXInLCAnT2NjdXBhbmN5Jyk7XG4gICAgZGF0YS5hZGRDb2x1bW4oJ251bWJlcicsICdOb2lzZScpO1xuICAgIGRhdGEuYWRkQ29sdW1uKCdudW1iZXInLCAnSHVtaWRpdHknKTtcblxuXG4gICAgZm9yKCB2YXIgaSA9IDE7IGkgPCA0MTsgaSsrKVxuICAgIHtcblxuICAgICAgdmFyIHRpbWVzbG90ID0gc3RvcmVEYXRhW3N0b3JlXVsnaGlzdG9yeSddWzBdWyd0aW1lcyddW2ktMV1bJ3RpbWVzbG90J10udG9TdHJpbmcoKTtcbiAgICAgIHZhciB0aW1lc2xvdEFycmF5ID0gdGltZXNsb3Quc3BsaXQoJycpO1xuICAgICAgXG4gICAgICB2YXIgaG91ciA9IHRpbWVzbG90QXJyYXlbMTFdLmNvbmNhdCh0aW1lc2xvdEFycmF5WzEyXSk7XG4gICAgICB2YXIgbWluID0gdGltZXNsb3RBcnJheVsxNF0uY29uY2F0KHRpbWVzbG90QXJyYXlbMTVdKTtcbiAgICAgIHZhciB0aW1lID0gaG91ci5jb25jYXQobWluKTtcblxuXG5cblxuICAgICAgZGF0YS5hZGRSb3dzKFtcbiAgICAgICAgICBbXG4gICAgICAgICAgICAgIFxuICAgICAgICAgICAgICB0aW1lLCBcbiAgICAgICAgICAgICAgc3RvcmVEYXRhW3N0b3JlXVsnaGlzdG9yeSddWzBdWyd0aW1lcyddW2ktMV1bJ29jY3VwYW5jeSddKjEwMCwgXG4gICAgICAgICAgICAgIHN0b3JlRGF0YVtzdG9yZV1bJ2hpc3RvcnknXVswXVsndGltZXMnXVtpLTFdWydub2lzZSddKjEwMCxcbiAgICAgICAgICAgICAgc3RvcmVEYXRhW3N0b3JlXVsnaGlzdG9yeSddWzBdWyd0aW1lcyddW2ktMV1bJ2h1bWlkaXR5J10qMTAwXG4gICAgICAgICAgXVxuICAgICAgXVxuICAgICAgKTtcblxuICAgIH1cblxuXG4gICAgICB2YXIgb3B0aW9ucyA9IHtcbiAgICAgICAgaEF4aXM6IHsgXG4gICAgICAgICAgc2hvd1RleHRFdmVyeSA6ICc0JyxcbiAgICAgICAgICBncmlkbGluZXMgOntjb3VudDogJzEwJ31cbiAgICAgICAgfSxcbiAgICAgICAgdkF4aXM6IHtcbiAgICAgICAgICBiYXNlbGluZTogMFxuICAgICAgICB9LFxuICAgICAgICBjdXJ2ZVR5cGU6ICdmdW5jdGlvbicsXG4gICAgICAgIHdpZHRoOiAnNzAwJyxcbiAgICAgICAgbGVnZW5kOiB7IHBvc2l0aW9uOiAnYm90dG9tJyB9XG4gICAgICB9O1xuXG4gICAgdmFyIGNoYXJ0X2RpdiA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdjaGFydF9kaXYnKTtcbiAgICB2YXIgY2hhcnQgPSBuZXcgZ29vZ2xlLnZpc3VhbGl6YXRpb24uTGluZUNoYXJ0KGNoYXJ0X2Rpdik7XG5cbiAgICAvLyBXYWl0IGZvciB0aGUgY2hhcnQgdG8gZmluaXNoIGRyYXdpbmcgYmVmb3JlIGNhbGxpbmcgdGhlIGdldEltYWdlVVJJKCkgbWV0aG9kLlxuICAgIGdvb2dsZS52aXN1YWxpemF0aW9uLmV2ZW50cy5hZGRMaXN0ZW5lcihjaGFydCwgJ3JlYWR5JywgZnVuY3Rpb24gKCkgeyB9KTtcblxuICAgIGNoYXJ0LmRyYXcoZGF0YSwgb3B0aW9ucyk7XG4gICAgcmV0dXJuKCc8aW1nIHNyYz1cIicgKyBjaGFydC5nZXRJbWFnZVVSSSgpICsgJ1wiPicpO1xufVxuIiwiICAgIHZhciBncm91bmRGbG9vcjtcbiAgICB2YXIgZ3JvdW5kRmxvb3JSZXFVUkwgPSAnYXBpL2dyb3VuZEZsb29yU3RvcmVzLmpzb24nO1xuICAgIHZhciBncm91bmRGbG9vclJlcSA9IG5ldyBYTUxIdHRwUmVxdWVzdCgpO1xuICAgIGdyb3VuZEZsb29yUmVxLm9wZW4oJ0dFVCcsIGdyb3VuZEZsb29yUmVxVVJMKTtcbiAgICBncm91bmRGbG9vclJlcS5zZW5kKCk7XG4gICAgZ3JvdW5kRmxvb3JSZXEub25sb2FkID0gKCkgPT4ge1xuICAgICAgICB2YXIgZ3JvdW5kRmxvb3JTdG9yZXMgPSBncm91bmRGbG9vclJlcS5yZXNwb25zZTtcbiAgICAgICAgdmFyIG9iaiA9IEpTT04ucGFyc2UoZ3JvdW5kRmxvb3JTdG9yZXMpO1xuICAgICAgICBncm91bmRGbG9vciA9IG9iajtcbiAgICB9XG5cbiAgICB2YXIgZmlyc3RGbG9vcjtcbiAgICB2YXIgZmlyc3RGbG9vclJlcVVSTCA9ICdhcGkvZmlyc3RGbG9vclN0b3Jlcy5qc29uJztcbiAgICB2YXIgZmlyc3RGbG9vclJlcSA9IG5ldyBYTUxIdHRwUmVxdWVzdCgpO1xuICAgIGZpcnN0Rmxvb3JSZXEub3BlbignR0VUJywgZmlyc3RGbG9vclJlcVVSTCk7XG4gICAgZmlyc3RGbG9vclJlcS5zZW5kKCk7XG4gICAgZmlyc3RGbG9vclJlcS5vbmxvYWQgPSAoKSA9PiB7XG4gICAgICAgIHZhciBmaXJzdEZsb29yU3RvcmVzID0gZmlyc3RGbG9vclJlcS5yZXNwb25zZTtcbiAgICAgICAgdmFyIG9iaiA9IEpTT04ucGFyc2UoZmlyc3RGbG9vclN0b3Jlcyk7XG4gICAgICAgIGZpcnN0Rmxvb3IgPSBvYmo7XG4gICAgfVxuXG4gICAgdmFyIHN0b3JlRGF0YTtcbiAgICB2YXIgc3RvcmVSZXFVUkwgPSAnYXBpL2RhdGEuanNvbic7XG4gICAgdmFyIHN0b3JlUmVxID0gbmV3IFhNTEh0dHBSZXF1ZXN0KCk7XG4gICAgc3RvcmVSZXEub3BlbignR0VUJywgc3RvcmVSZXFVUkwpO1xuICAgIHN0b3JlUmVxLnNlbmQoKTtcbiAgICBzdG9yZVJlcS5vbmxvYWQgPSAoKSA9PiB7XG4gICAgICAgIHZhciBzdG9yZURhdGFzID0gc3RvcmVSZXEucmVzcG9uc2U7XG4gICAgICAgIHZhciBvYmogPSBKU09OLnBhcnNlKHN0b3JlRGF0YXMpO1xuICAgICAgICBzdG9yZURhdGEgPSBvYmo7XG4gICAgfVxuIiwiZnVuY3Rpb24gc2V0RW50aXR5SGlnaGxpZ2h0cygpIHtcbiAgICBmb3IodmFyIGkgPSAwOyBpIDwgZ3JvdW5kRmxvb3Iuc3RvcmVzLmxlbmd0aDsgaSsrKXtcbiAgICAgICAgbWFwLmluZG9vcnMuc2V0RW50aXR5SGlnaGxpZ2h0cyhncm91bmRGbG9vci5zdG9yZXNbaV0uaWQudG9TdHJpbmcoKSwgcmFuZG9tQ29sb3IoKSk7XG4gICAgfVxuICAgIGZvcih2YXIgaSA9IDA7IGkgPCBmaXJzdEZsb29yLnN0b3Jlcy5sZW5ndGg7IGkrKyl7XG4gICAgICAgIG1hcC5pbmRvb3JzLnNldEVudGl0eUhpZ2hsaWdodHMoZmlyc3RGbG9vci5zdG9yZXNbaV0uaWQudG9TdHJpbmcoKSwgcmFuZG9tQ29sb3IoKSk7XG4gICAgfVxuXG59XG5mdW5jdGlvbiBzZXRTdG9yZUhpZ2hsaWdodHMoc3RvcmUsIGNvbG91cil7XG4gICAgc3RvcmUgPSBzdG9yZS50b1N0cmluZygpO1xuICAgIG1hcC5pbmRvb3JzLnNldEVudGl0eUhpZ2hsaWdodHMoc3RvcmUsIGNvbG91cik7XG59XG5cbmZ1bmN0aW9uIHJhbmRvbUNvbG9yKCl7XG4gICAgdmFyIHJlZCA9IE1hdGguZmxvb3IoTWF0aC5yYW5kb20oKSAqIDI1Nik7XG4gICAgdmFyIGdyZWVuID0gMjU1IC0gcmVkO1xuICAgIHJldHVybiBbcmVkLCBncmVlbiwgMCwgMjAwXTtcbn1cblxuZnVuY3Rpb24gY2xlYXJFbnRpdHlIaWdobGlnaHRzKCl7XG4gICAgbWFwLmluZG9vcnMuY2xlYXJFbnRpdHlIaWdobGlnaHRzKCk7XG59IiwidmFyIG1hcCA9IEwuV3JsZC5tYXAoXCJtYXBcIiwgXCI5ZDg3NjY0NmY3ZDgzY2M3MDllZGJlMjA0YzgxZDU0NlwiLCB7XG4gICAgY2VudGVyOiBbNTYuNDU5OCwgLTIuOTcyOF0sXG4gICAgem9vbTogMTcsXG4gICAgaW5kb29yc0VuYWJsZWQ6IHRydWVcbn0pO1xuICB2YXIgaW5kb29yQ29udHJvbCA9IG5ldyBXcmxkSW5kb29yQ29udHJvbChcIndpZGdldC1jb250YWluZXJcIiwgbWFwKTtcbiAgdmFyIGN1cnJlbnRJbmRvb3JNYXBJZDtcbiAgdmFyIGN1cnJlbnRGbG9vcjtcbiAgdmFyIGVudGl0eUlkc1RvUG9zaXRpb24gPSB7fTtcbiAgXG4gIHZhciBsYXN0TW91c2VEb3duO1xuICBmdW5jdGlvbiBvbk1vdXNlRG93bihldmVudCkge1xuICAgIGxhc3RNb3VzZURvd24gPSBldmVudC5sYXRsbmc7XG4gIH1cbiAgXG4gIGZ1bmN0aW9uIG9uSW5kb29yRW50aXR5Q2xpY2tlZChldmVudCkge1xuICAgIGV2ZW50Lmlkcy5mb3JFYWNoKGlkZW50aWZ5RW50aXR5KTtcbiAgfVxuXG4gIGZ1bmN0aW9uIGV4cG9ydElkTWFwKCkge1xuICAgIGNvbnNvbGUubG9nKEpTT04uc3RyaW5naWZ5KGVudGl0eUlkc1RvUG9zaXRpb24pKTtcbiAgfVxuICBcbiAgZnVuY3Rpb24gb25JbmRvb3JNYXBFbnRlcmVkKGV2ZW50KSB7XG4gICAgY3VycmVudEluZG9vck1hcElkID0gZXZlbnQuaW5kb29yTWFwLmdldEluZG9vck1hcElkKCk7XG4gICAgY3VycmVudEZsb29yID0gbWFwLmluZG9vcnMuZ2V0Rmxvb3IoKS5nZXRGbG9vckluZGV4KCk7XG4gIH1cbiAgXG4gIGZ1bmN0aW9uIG9uSW5kb29yTWFwRmxvb3JDaGFuZ2VkKCkge1xuICAgIGN1cnJlbnRGbG9vciA9IG1hcC5pbmRvb3JzLmdldEZsb29yKCkuZ2V0Rmxvb3JJbmRleCgpO1xuICB9XG4gIFxuICBmdW5jdGlvbiBpZGVudGlmeUVudGl0eShpZCkge1xuICAgIHZhciBsYXRMbmcgPSBsYXN0TW91c2VEb3duO1xuXG4gICAgdmFyIGdyYXBoID0gZHJhd0Jhc2ljKGlkKTtcbiAgICBcbiAgICB2YXIgcG9wdXBPcHRpb25zID0geyBcbiAgICAgIGluZG9vck1hcElkOiBjdXJyZW50SW5kb29yTWFwSWQsIFxuICAgICAgaW5kb29yTWFwRmxvb3JJbmRleDogY3VycmVudEZsb29yLCBcbiAgICAgIGF1dG9DbG9zZTogZmFsc2UsIFxuICAgICAgY2xvc2VPbkNsaWNrOiBmYWxzZSxcbiAgICAgIG1pbldpZHRoOiBcIjVcIiAgICAgICAgICBcbiAgICB9O1xuICAgIHZhciBwb3B1cCA9IEwucG9wdXAocG9wdXBPcHRpb25zKVxuICAgICAgLnNldExhdExuZyhsYXRMbmcpXG4gICAgICAuYWRkVG8obWFwKVxuICAgICAgLnNldENvbnRlbnQoZ3JhcGgpO1xuICAgIGVudGl0eUlkc1RvUG9zaXRpb25baWRdID0geyBcImxhdExuZ1wiOiBsYXRMbmcsIFwiaW5kb29ySWRcIjogY3VycmVudEluZG9vck1hcElkLCBcImZsb29ySW5kZXhcIjogY3VycmVudEZsb29yIH0gO1xuICB9XG5cbiAgbWFwLmluZG9vcnMub24oXCJpbmRvb3JtYXBlbnRlclwiLCBvbkluZG9vck1hcEVudGVyZWQpO1xuICBtYXAuaW5kb29ycy5vbihcImluZG9vcm1hcGZsb29yY2hhbmdlXCIsIG9uSW5kb29yTWFwRmxvb3JDaGFuZ2VkKVxuICBtYXAuaW5kb29ycy5vbihcImluZG9vcmVudGl0eWNsaWNrXCIsIG9uSW5kb29yRW50aXR5Q2xpY2tlZCk7XG4gIG1hcC5vbihcIm1vdXNlZG93blwiLCBvbk1vdXNlRG93bik7IiwiLy8gdmFyIGQgPSBuZXcgRGF0ZSgpO1xuLy8gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoXCJkYXRlXCIpLmlubmVySFRNTCA9IGQ7IiwiLy9PbmxvYWQgZnVuY3Rpb24gdG8gc2V0dXAgc2xpZGVyc1xud2luZG93Lm9ubG9hZCA9IGZ1bmN0aW9uICgpe1xuICAgIHZhciBzbGlkZXJzID0gZG9jdW1lbnQuZ2V0RWxlbWVudHNCeUNsYXNzTmFtZShcInJhbmdlUGlja2VyXCIpO1xuICAgIC8vIHZhciB0ZXh0Qm94ZXMgPSBkb2N1bWVudC5nZXRFbGVtZW50c0J5Q2xhc3NOYW1lKFwidGV4dEJveFwiKTtcbiAgICBbXS5mb3JFYWNoLmNhbGwoc2xpZGVycywgZnVuY3Rpb24gKHNsaWRlcikgeyAgICBcbiAgICAgICAgc2xpZGVyLm1pbiA9IDEwO1xuICAgICAgICBzbGlkZXIubWF4ID0gNTA7XG4gICAgICAgIHNsaWRlci5zdGVwID0gMTA7XG4gICAgICAgIHNsaWRlci52YWx1ZSA9IDMwO1xuICAgIH0pO1xuXG4gICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoXCJTQURcIikuYWRkRXZlbnRMaXN0ZW5lcihcImNsaWNrXCIsIHByZXNldHNVcGRhdGUoMCkpO1xuICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKFwiR09PRFwiKS5hZGRFdmVudExpc3RlbmVyKFwiY2xpY2tcIiwgcHJlc2V0c1VwZGF0ZSgyKSk7XG4gICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoXCJOT1JNQUxcIikuYWRkRXZlbnRMaXN0ZW5lcihcImNsaWNrXCIsIHByZXNldHNVcGRhdGUoMSkpO1xufVxuXG5mdW5jdGlvbiBwcmVzZXRzVXBkYXRlKGxldmVsKXtcbiAgICB2YXIgb2NjdXBhbmN5ID0gWzEwLDMwLDUwXTtcbiAgICB2YXIgbm9pc2UgPSBbMTAsMzAsNTBdO1xuICAgIHZhciBodW1pZGl0eSA9IFsxMCwzMCw1MF07XG5cbiAgICBmb3IodmFyIGk9MDsgaSA8IDM7IGkrKyl7XG4gICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKFwib2NjdXBhbmN5LXNsaWRlclwiKS52YWx1ZSA9IG9jY3VwYW5jeVtsZXZlbF07XG4gICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKFwibm9pc2Utc2xpZGVyXCIpLnZhbHVlID0gbm9pc2VbbGV2ZWxdO1xuICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChcImh1bWlkaXR5LXNsaWRlclwiKS52YWx1ZSA9IGh1bWlkaXR5W2xldmVsXTtcbiAgICB9XG59IiwiLy8gQ2FsbGVkIHdoZW4gYSBzbGlkZXIgaXMgdXBkYXRlZC4gXG5mdW5jdGlvbiB1cGRhdGVNYXBGcm9tU2xpZGVycygpeyBcblxuICAgIHZhciBzdG9yZXMgPSBzdG9yZURhdGE7XG4gICAgdmFyIGN1cnJlbnQgPSBnZXRDdXJyZW50U2xpZGVyTGV2ZWwoKTtcbiAgICB2YXIgbGV2ZWwgPSBNYXRoLnJvdW5kKGdldEF2ZXJhZ2VTbGlkZXJMZXZlbChjdXJyZW50KSk7XG4gICAgdmFyIG1heCA9IGdldE1heFRvbGVyYW5jZUxldmVsKGxldmVsKTtcbiAgICB2YXIgbWluID0gZ2V0TWluVG9sZXJhbmNlTGV2ZWwobGV2ZWwpO1xuXG4gICAgZm9yKHZhciBpID0gMDsgaSA8IHN0b3Jlcy5sZW5ndGg7IGkrKyl7XG4gICAgICAgIHZhciBzdG9yZUlEID0gc3RvcmVzW2ldLmlkO1xuICAgICAgICAvL3ZhciBjdXJyZW50RGF0YSA9IGdldEN1cnJlbnREYXRhKHN0b3JlSUQsIE1hdGgucm91bmQobGV2ZWwpKTtcbiAgICAgICAgdmFyIGRhdGFBcnJheSA9IGdldEN1cnJlbnRUaW1lc2xvdChzdG9yZUlEKTtcbiAgICAgICAgY29uc29sZS5sb2coZGF0YUFycmF5LCBpKTtcbiAgICAgICAgdmFyIGNvbG91ciA9IGNhbGN1bGF0ZUNvbG91cihkYXRhQXJyYXksIG1heCwgbWluKTsgXG5cbiAgICAgICAgc2V0U3RvcmVIaWdobGlnaHRzKHN0b3JlSUQsIGNvbG91cik7XG4gICAgfVxuXG59XG5cbi8vIEdldHMgY3VycmVudCBsZXZlbHMgc2xpZGVycyBhcmUgYXQsIHBhcnNlcyB0aGVtIGludG8gbnVtYmVycy5cbi8vIFJldHVybnMgYXMgYW4gYXJyYXkuXG5mdW5jdGlvbiBnZXRDdXJyZW50U2xpZGVyTGV2ZWwoKXtcbiAgICB2YXIgc2xpZGVyQXJyYXkgPVtdO1xuICAgIHZhciBzbGlkZXJzID0gZG9jdW1lbnQuZ2V0RWxlbWVudHNCeUNsYXNzTmFtZShcInJhbmdlUGlja2VyXCIpO1xuICAgIFtdLmZvckVhY2guY2FsbChzbGlkZXJzLCBmdW5jdGlvbiAoc2xpZGVyKSB7XG4gICAgICAgIHNsaWRlckFycmF5LnB1c2gocGFyc2VJbnQoc2xpZGVyLnZhbHVlLCAxMCkpO1xuICAgIH0pO1xuICAgIGNvbnNvbGUubG9nKFwiU2xpZGVyIFZhbHVlczogXCIgKyBzbGlkZXJBcnJheSk7XG4gICAgcmV0dXJuIHNsaWRlckFycmF5O1xufVxuXG5cbi8vIFRha2VzIGFuIGFycmF5IG9mIG51bWJlcnMgKGludClcbi8vIFJldHVybnMgdGhlIGF2ZXJhZ2Ugb2YgdGhlIGFycmF5LlxuLy8gQ29kZSBmb3IgYXZhcmFnaW5nIGFycmF5cyBmb3VuZCB2aWEgR29vZ2xlIGF0IGh0dHBzOi8vZ2lzdC5naXRodWIuY29tL2Jtb3JlbGxpMjUvNDU2NGI4ZmYzNWI0N2Q4YTlkYjZiMGRkYTExNDM0NjVcbmZ1bmN0aW9uIGdldEF2ZXJhZ2VTbGlkZXJMZXZlbChzbGlkZXJBcnJheSl7XG4gICAgY29uc3QgYXJyQXZnID0gYXJyID0+IGFyci5yZWR1Y2UoKGEsYikgPT4gYSArIGIsIDApIC8gYXJyLmxlbmd0aDtcbiAgICByZXR1cm4gYXJyQXZnKHNsaWRlckFycmF5KTtcbn07XG5cbmZ1bmN0aW9uIGdldE1heFRvbGVyYW5jZUxldmVsKHNsaWRlckF2Zyl7XG4gICAgdmFyIG1heFRvbGVyYWJsZTtcbiAgICBzd2l0Y2goc2xpZGVyQXZnKXtcbiAgICAgICAgY2FzZSAxOlxuICAgICAgICBjYXNlIDI6XG4gICAgICAgICAgICByZXR1cm4gbWF4VG9sZXJhYmxlID0gMC40O1xuICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgIGNhc2UgMzpcbiAgICAgICAgICAgIHJldHVybiBtYXhUb2xlcmFibGUgPSAwLjY7XG4gICAgICAgICAgICBicmVhaztcbiAgICAgICAgY2FzZSA0OlxuICAgICAgICBjYXNlIDU6XG4gICAgICAgICAgICByZXR1cm4gbWF4VG9sZXJhYmxlID0gMC45O1xuICAgICAgICAgICAgYnJlYWs7XG4gICAgfVxufVxuZnVuY3Rpb24gZ2V0TWluVG9sZXJhbmNlTGV2ZWwoc2xpZGVyQXZnKXtcbiAgICB2YXIgbWluVG9sZXJhYmxlO1xuXG4gICAgc3dpdGNoKHNsaWRlckF2Zyl7XG4gICAgICAgIGNhc2UgMTpcbiAgICAgICAgY2FzZSAyOlxuICAgICAgICAgICAgcmV0dXJuIG1pblRvbGVyYWJsZSA9IDAuMTtcbiAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICBjYXNlIDM6XG4gICAgICAgICAgICByZXR1cm4gbWluVG9sZXJhYmxlID0gMC4zO1xuICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgIGNhc2UgNDpcbiAgICAgICAgY2FzZSA1OlxuICAgICAgICAgICAgcmV0dXJuIG1pblRvbGVyYWJsZSA9IDAuNjtcbiAgICAgICAgICAgIGJyZWFrO1xuICAgIH1cbn1cbi8vIHBhcnNlRGF0YU9iaihvYmopO1xuLy8gICAgIG9ialxuLy8gICAgIGN1cnJlbnREYXRhQXJyYXkgPSBbXTtcbi8vICAgICBjdXJyZW50QXJyYXkucHVzaChjdXJyZW50VGltZXNsb3RbJ29jY3VwYW5jeSddKTtcbi8vICAgICBjdXJyZW50QXJyYXkucHVzaChjdXJyZW50VGltZXNsb3RbJ25vaXNlJ10pO1xuLy8gICAgIGN1cnJlbnRBcnJheS5wdXNoKGN1cnJlbnRUaW1lc2xvdFsnaHVtaWRpdHknXSk7XG5cbi8vICAgICByZXR1cm4gY2FsY3VsYXRlQ29sb3VyKGN1cnJlbnRBcnJheSwgbWF4VG9sZXJhYmxlLCBtaW5Ub2xlcmFibGUpO1xuLy8gfVxuXG5mdW5jdGlvbiBnZXRDdXJyZW50VGltZXNsb3QoaWQpe1xuICAgIHZhciBzdG9yZTtcbiAgICBmb3IoIHZhciBpID0gMDsgaSA8IGdyb3VuZEZsb29yLnN0b3Jlcy5sZW5ndGg7IGkrKykge1xuICAgICAgICBpZiAoc3RvcmVEYXRhW2ldWydpZCddID09IGlkKSB7XG4gICAgICAgICAgICBzdG9yZSA9IGk7XG4gICAgICAgICAgICBicmVhaztcbiAgICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gc3RvcmVEYXRhW3N0b3JlXVsnaGlzdG9yeSddWzBdWyd0aW1lcyddWzBdO1xufVxuXG5mdW5jdGlvbiBjaGVja1ZhbHVlKHZhbHVlLCBtYXgsIG1pbil7XG4gICAgdmFyIGNvbG91ckxldmVsID0gMDtcbiAgICBpZihwYXJzZUZsb2F0KHZhbHVlKSA+IG1heCl7IGNvbG91ckxldmVsID0gNTsgfTtcbiAgICBpZihwYXJzZUZsb2F0KHZhbHVlKSA8IG1pbil7IGNvbG91ckxldmVsID0gMTsgfTtcbiAgICBpZihwYXJzZUZsb2F0KHZhbHVlKSA8IG1heCAmJiBwYXJzZUZsb2F0KHZhbHVlID4gbWluKSl7IGNvbG91ckxldmVsID0gMzsgfTtcbiAgICBjb25zb2xlLmxvZyhcIlZhbHVlIEJlaW5nIENoZWNrZWQ6IFwiICsgcGFyc2VGbG9hdCh2YWx1ZSkgKyBcIiBDb2xvdXIgTGV2ZWxcIiArIGNvbG91ckxldmVsKTtcbiAgICByZXR1cm4gcGFyc2VJbnQoY29sb3VyTGV2ZWwpO1xufVxuXG5mdW5jdGlvbiBjYWxjdWxhdGVDb2xvdXIoY3VycmVudERhdGFPYmosIG1heCwgbWluKXtcbiAgICB2YXIgY29sb3VyTGV2ZWwgPSAwO1xuICAgIHZhciBjb2xvdXI7XG4gICAgdmFyIG9jY3VwYW5jeSA9IGN1cnJlbnREYXRhT2JqLm9jY3VwYW5jeTtcbiAgICB2YXIgbm9pc2UgPSBjdXJyZW50RGF0YU9iai5ub2lzZTtcbiAgICB2YXIgaHVtaWRpdHkgPSBjdXJyZW50RGF0YU9iai5odW1pZGl0eTtcbiAgICBjb25zb2xlLmxvZyhcIk9jY3VwYW55fk5vaXNlfkh1bWlkaXR5OiBcIiArIG9jY3VwYW5jeSArIFwiIFwiICsgbm9pc2UgKyBcIiBcIiArIGh1bWlkaXR5KVxuICAgIGNvbG91ckxldmVsICs9IGNoZWNrVmFsdWUob2NjdXBhbmN5LG1heCxtaW4pO1xuICAgIGNvbG91ckxldmVsICs9IGNoZWNrVmFsdWUobm9pc2UsIG1heCwgbWluKTtcbiAgICBjb2xvdXJMZXZlbCArPSBjaGVja1ZhbHVlKGh1bWlkaXR5LCBtYXgsIG1pbik7XG4gICAgXG4gICAgdmFyIGF2Z0NvbG91ckxldmVsID0gTWF0aC5yb3VuZChjb2xvdXJMZXZlbCAvIDMpO1xuICAgIGNvbnNvbGUubG9nKGF2Z0NvbG91ckxldmVsKTtcbiAgICBzd2l0Y2goYXZnQ29sb3VyTGV2ZWwpe1xuICAgICAgICBjYXNlIDE6XG4gICAgICAgIGNhc2UgMjpcbiAgICAgICAgICAgIGNvbG91ciA9IFsyNTUsMCwwLDIwMF07XG4gICAgICAgICAgICBicmVhaztcbiAgICAgICAgY2FzZSAzOlxuICAgICAgICAgICAgY29sb3VyID0gWzI1NSwxNDAsMCwyMDBdO1xuICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgIGNhc2UgNDpcbiAgICAgICAgY2FzZSA1OlxuICAgICAgICAgICAgY29sb3VyID0gWzAsMjU1LDAsMjAwXTtcbiAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICBkZWZhdWx0OiBcbiAgICAgICAgICAgIGNvbG91cj0gWzI1NSwyNTUsMjAwLCAyMDBdO1xuICAgIH1cbiAgICByZXR1cm4gY29sb3VyO1xufVxuIl19
