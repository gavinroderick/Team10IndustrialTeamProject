google.charts.load('current', {packages: ['corechart', 'line']});
google.charts.setOnLoadCallback(drawBasic);


    // var groundFloor;
    // var groundFloorReqURL = 'api/groundFloorStores.json';
    // var groundFloorReq = new XMLHttpRequest();
    // groundFloorReq.open('GET', groundFloorReqURL);
    // groundFloorReq.send();
    // groundFloorReq.onload = () => {
    //     var groundFloorStores = groundFloorReq.response;
    //     var obj = JSON.parse(groundFloorStores);
    //     groundFloor = obj;
    // }

    // var firstFloor;
    // var firstFloorReqURL = 'api/firstFloorStores.json';
    // var firstFloorReq = new XMLHttpRequest();
    // firstFloorReq.open('GET', firstFloorReqURL);
    // firstFloorReq.send();
    // firstFloorReq.onload = () => {
    //     var firstFloorStores = firstFloorReq.response;
    //     var obj = JSON.parse(firstFloorStores);
    //     firstFloor = obj;
    // }

    // var storeData;
    // var storeReqURL = 'api/data.json';
    // var storeReq = new XMLHttpRequest();
    // storeReq.open('GET', storeReqURL);
    // storeReq.send();
    // storeReq.onload = () => {
    //     var storeDatas = storeReq.response;
    //     var obj = JSON.parse(storeDatas);
    //     storeData = obj;
    // }

function drawBasic(id) {

    var store;

    var currentTime = new Date();
    var currentTimeArray = currentTime.toLocaleTimeString('it-IT').split(':');


    for( var i = 0; i < groundFloor.stores.length; i++)
    {
        if (storeData[i]['id'] == id)
        {
            store = i;
            break;
        }
    }
    for( var i = 0; i < firstFloor.stores.length; i++)
    {
        if (storeData[i]['id'] == id)
        {
            store = i;
            break;
        }
    }

    var data = new google.visualization.DataTable();

    data.addColumn('string', 'Time');
    data.addColumn('number', 'Occupancy');
    data.addColumn('number', 'Noise');
    data.addColumn('number', 'Humidity');
    data.addColumn('number', 'Occupancy Prediction');
    data.addColumn('number', 'Noise Prediction');
    data.addColumn('number', 'Humidity Prediction');


    for( var i = 1; i < 41; i++)
    {

      var timeslot = storeData[store]['history'][0]['times'][i-1]['timeslot'].toString();
      var timeslotArray = timeslot.split('');
      
      var hour = timeslotArray[11].concat(timeslotArray[12]);
      var min = timeslotArray[14].concat(timeslotArray[15]);
      var time = hour.concat(":");
      time = time.concat(min);

      if(hour < currentTimeArray[0])
      {
        data.addRows([
              [
                  
                  time, 
                  storeData[store]['history'][0]['times'][i-1]['occupancy']*100, 
                  storeData[store]['history'][0]['times'][i-1]['noise']*100,
                  storeData[store]['history'][0]['times'][i-1]['humidity']*100,
                  null,
                  null,
                  null
              ]
          ]
          );
      } else if (hour == currentTimeArray[0]){
        if(min <= currentTimeArray[1])
        {
          data.addRows([
              [
                  
                  time, 
                  storeData[store]['history'][0]['times'][i-1]['occupancy']*100, 
                  storeData[store]['history'][0]['times'][i-1]['noise']*100,
                  storeData[store]['history'][0]['times'][i-1]['humidity']*100,
                  null,
                  null,
                  null
              ]
          ]
          );
        } else {
          data.addRows([
              [
                  
                  time, 
                  null, 
                  null,
                  null,
                  storeData[store]['history'][0]['times'][i-1]['occupancy']*100, 
                  storeData[store]['history'][0]['times'][i-1]['noise']*100,
                  storeData[store]['history'][0]['times'][i-1]['humidity']*100
              ]
          ]
          );
        }
      }else {
        data.addRows([
              [
                  
                  time, 
                  null, 
                  null,
                  null,
                  storeData[store]['history'][0]['times'][i-1]['occupancy']*100, 
                  storeData[store]['history'][0]['times'][i-1]['noise']*100,
                  storeData[store]['history'][0]['times'][i-1]['humidity']*100
              ]
          ]
          );
      }
    }


      var options = {
        hAxis: { 
          showTextEvery : '4',
          gridlines :{count: '10'}
        },
        vAxis: {
          baseline: "0"
        },
        curveType: 'function',
        width: '700',
        legend: { position: 'bottom' }
      };

    var chart_div = document.getElementById('chart_div');
    var chart = new google.visualization.LineChart(chart_div);

    // Wait for the chart to finish drawing before calling the getImageURI() method.
    google.visualization.events.addListener(chart, 'ready', function () { });

    chart.draw(data, options);
    return('<img src="' + chart.getImageURI() + '">');
}
    var groundFloor;
    var groundFloorReqURL = 'api/groundFloorStores.json';
    var groundFloorReq = new XMLHttpRequest();
    groundFloorReq.open('GET', groundFloorReqURL);
    groundFloorReq.send();
    groundFloorReq.onload = () => {
        var groundFloorStores = groundFloorReq.response;
        var obj = JSON.parse(groundFloorStores);
        groundFloor = obj;
    }

    var firstFloor;
    var firstFloorReqURL = 'api/firstFloorStores.json';
    var firstFloorReq = new XMLHttpRequest();
    firstFloorReq.open('GET', firstFloorReqURL);
    firstFloorReq.send();
    firstFloorReq.onload = () => {
        var firstFloorStores = firstFloorReq.response;
        var obj = JSON.parse(firstFloorStores);
        firstFloor = obj;
    }

    var storeData;
    var storeReqURL = 'api/data.json';
    var storeReq = new XMLHttpRequest();
    storeReq.open('GET', storeReqURL);
    storeReq.send();
    storeReq.onload = () => {
        var storeDatas = storeReq.response;
        var obj = JSON.parse(storeDatas);
        storeData = obj;
    }

function setEntityHighlights() {
    updateMapFromSliders();
}
function setStoreHighlights(store, colour){
    store = store.toString();
    map.indoors.setEntityHighlights(store, colour);
}

function randomColor(){
    var red = Math.floor(Math.random() * 256);
    var green = 255 - red;
    return [red, green, 0, 200];
}

function clearEntityHighlights(){
    map.indoors.clearEntityHighlights();
}
var map = L.Wrld.map("map", "9d876646f7d83cc709edbe204c81d546", {
    center: [56.4598, -2.9728],
    zoom: 17,
    indoorsEnabled: true
});
  var indoorControl = new WrldIndoorControl("widget-container", map);
  var currentIndoorMapId;
  var currentFloor;
  var entityIdsToPosition = {};
  var d;
  var popup;
  
  var lastMouseDown;
  function onMouseDown(event) {
    lastMouseDown = event.latlng;
  }
  
  function onIndoorEntityClicked(event) {
    event.ids.forEach(identifyEntity);
  }

  function exportIdMap() {
    console.log(JSON.stringify(entityIdsToPosition));
  }
  
  function onIndoorMapEntered(event) {
    map.indoors.setFloor(0);
    map.setView([56.4598, -2.9728], 17);
    currentIndoorMapId = event.indoorMap.getIndoorMapId();
    currentFloor = map.indoors.getFloor().getFloorIndex();
  }
  
  function onIndoorMapFloorChanged() {
    currentFloor = map.indoors.getFloor().getFloorIndex();
  }

  function getStoreName(id){
    if(currentFloor == 0)
    {
      for(var i = 0; i < groundFloor.stores.length; i++)
      {
        if(groundFloor.stores[i].id == id)
        {
          //console.log(groundFloor.stores[i].store);
          return groundFloor.stores[i].store;
        }
      }
    }
  }

  function validId(id) {

    for( var i = 0; i < groundFloor.stores.length; i++)
    {
          if (storeData[i]['id'] == id)
          {
              return i;
          }
    }
    for( var i = 0; i < firstFloor.stores.length; i++)
    {
          if (storeData[i]['id'] == id)
          {
              return i;
          }
    }
    return null;
}
  
  function identifyEntity(id) {
    var latLng = lastMouseDown;
    d = new Date();

    var valid = validId(id);

    if(valid != null)
    {
      map.setView(latLng, 17);
      
      var popupOptions = { 
        indoorMapId: currentIndoorMapId, 
        indoorMapFloorIndex: currentFloor, 
        autoClose: true, 
        closeOnClick: true,
        minWidth: "700"          
      };
      popup = L.popup(popupOptions)
        .setLatLng(latLng)
        .addTo(map)
        .setContent(createMockHTMLElement(id, d, drawBasic(id)));
      entityIdsToPosition[id] = { "latLng": latLng, "indoorId": currentIndoorMapId, "floorIndex": currentFloor } ;
    }

    setTimeout(updatePopup(id, d), 5000);
  }

  function updatePopup(id, d)
  {
    d = new Date();
    console.log(d.toLocaleTimeString('it-IT'));
    popup.setContent(createMockHTMLElement(id, d, drawBasic(id)));
  }

  map.indoors.on("indoormapenter", onIndoorMapEntered);
  map.indoors.on("indoormapfloorchange", onIndoorMapFloorChanged)
  map.indoors.on("indoorentityclick", onIndoorEntityClicked);
  map.on("mousedown", onMouseDown);

  function createMockHTMLElement(id, date, graphText){
    var graphHTML = '<div class="content">' +
                    '<h2>'+ getStoreName(id) +  ' ' + d.toLocaleTimeString('it-IT') +
                    graphText +
                    '</div>';
    return graphHTML;
}





/*                  '<div class="content">' +
                    '<h2>'+ getStoreName(id) + ' for the ' + d.getDate() + ' of Spetember 2018</h2>' +
                    graphText +
                    '</div>';
*/




//Onload function to setup sliders
window.onload = function (){
    var sliders = document.getElementsByClassName("rangePicker");
    // var textBoxes = document.getElementsByClassName("textBox");
    [].forEach.call(sliders, function (slider) {    
        slider.min = 1;
        slider.max = 5;
        slider.step = 1;
        slider.value = 3;
    });

    document.getElementById("SAD").addEventListener("click", presetsUpdate(0));
    document.getElementById("GOOD").addEventListener("click", presetsUpdate(2));
    document.getElementById("NORMAL").addEventListener("click", presetsUpdate(1));
}

function presetsUpdate(level){
    var occupancy = [1,3,5];
    var noise = [1,3,5];
    var humidity = [1,3,5];

    for(var i=0; i < 3; i++){
        document.getElementById("occupancy-slider").value = occupancy[level];
        document.getElementById("noise-slider").value = noise[level];
        document.getElementById("humidity-slider").value = humidity[level];
    }
}
// Called when a slider is updated. 
function updateMapFromSliders(){ 
    var stores = storeData;
    var current = getCurrentSliderLevel();
    var sliderOccupancy = current[0]/5;
    var sliderNoise = current[1]/5;
    var sliderHumidity = current[2]/5;
    console.log("Slider Values: " + sliderOccupancy + " " + sliderNoise + " " + sliderHumidity);

    for(var i = 0; i < stores.length; i++){
        var storeID = stores[i].id;
        var currentOccupancy = stores[i].history[0].times[0].occupancy;
        var currentNoise = stores[i].history[0].times[0].noise;
        var currentHumidity = stores[i].history[0].times[0].humidity;

        console.log("Values: " + currentOccupancy + " " + currentNoise + " " + currentHumidity);

        
        if(currentOccupancy >= sliderOccupancy && currentNoise >= sliderNoise && currentHumidity >= sliderHumidity){
            setStoreHighlights(storeID, [108,249,32, 200]);
        }
        else if(currentOccupancy < sliderOccupancy && currentNoise < sliderNoise && currentHumidity < sliderHumidity){
        	setStoreHighlights(storeID, [249,71,32, 200]);
        }
        else{
        	setStoreHighlights(storeID, [249,239,32, 200]);
        }
        /*
        else if((currentOccupancy > sliderOccupancy && currentOccupancy < sliderOccupancy + 0.1) || (currentNoise > sliderNoise && currentNoise < sliderNoise + 0.1) || (currentHumidity > sliderHumidity && currentHumidity < sliderHumidity + 0.1)){
        	setStoreHighlights(storeID, [249,239,32, 200]);
        }
        else{
        	setStoreHighlights(storeID, [249,71,32, 200]);
        }*/
    }

}

// Gets current levels sliders are at, parses them into numbers.
// Returns as an array.
function getCurrentSliderLevel(){
    var sliderArray =[];
    var sliders = document.getElementsByClassName("rangePicker");
    [].forEach.call(sliders, function (slider) {
        sliderArray.push(parseInt(slider.value, 10));
    });
    console.log("Slider Values: " + sliderArray);
    return sliderArray;
}

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImdyYXBoLmpzIiwibG9hZERhdGEuanMiLCJtYXBIaWdobGlnaHRpbmcuanMiLCJwb3B1cHMuanMiLCJzZXR0aW5ncy5qcyIsInNsaWRlcnMuanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQ3pLQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUNoQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQ2hCQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUNoSUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FDMUJBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EiLCJmaWxlIjoiYXBwLm1pbi5qcyIsInNvdXJjZXNDb250ZW50IjpbImdvb2dsZS5jaGFydHMubG9hZCgnY3VycmVudCcsIHtwYWNrYWdlczogWydjb3JlY2hhcnQnLCAnbGluZSddfSk7XHJcbmdvb2dsZS5jaGFydHMuc2V0T25Mb2FkQ2FsbGJhY2soZHJhd0Jhc2ljKTtcclxuXHJcblxyXG4gICAgLy8gdmFyIGdyb3VuZEZsb29yO1xyXG4gICAgLy8gdmFyIGdyb3VuZEZsb29yUmVxVVJMID0gJ2FwaS9ncm91bmRGbG9vclN0b3Jlcy5qc29uJztcclxuICAgIC8vIHZhciBncm91bmRGbG9vclJlcSA9IG5ldyBYTUxIdHRwUmVxdWVzdCgpO1xyXG4gICAgLy8gZ3JvdW5kRmxvb3JSZXEub3BlbignR0VUJywgZ3JvdW5kRmxvb3JSZXFVUkwpO1xyXG4gICAgLy8gZ3JvdW5kRmxvb3JSZXEuc2VuZCgpO1xyXG4gICAgLy8gZ3JvdW5kRmxvb3JSZXEub25sb2FkID0gKCkgPT4ge1xyXG4gICAgLy8gICAgIHZhciBncm91bmRGbG9vclN0b3JlcyA9IGdyb3VuZEZsb29yUmVxLnJlc3BvbnNlO1xyXG4gICAgLy8gICAgIHZhciBvYmogPSBKU09OLnBhcnNlKGdyb3VuZEZsb29yU3RvcmVzKTtcclxuICAgIC8vICAgICBncm91bmRGbG9vciA9IG9iajtcclxuICAgIC8vIH1cclxuXHJcbiAgICAvLyB2YXIgZmlyc3RGbG9vcjtcclxuICAgIC8vIHZhciBmaXJzdEZsb29yUmVxVVJMID0gJ2FwaS9maXJzdEZsb29yU3RvcmVzLmpzb24nO1xyXG4gICAgLy8gdmFyIGZpcnN0Rmxvb3JSZXEgPSBuZXcgWE1MSHR0cFJlcXVlc3QoKTtcclxuICAgIC8vIGZpcnN0Rmxvb3JSZXEub3BlbignR0VUJywgZmlyc3RGbG9vclJlcVVSTCk7XHJcbiAgICAvLyBmaXJzdEZsb29yUmVxLnNlbmQoKTtcclxuICAgIC8vIGZpcnN0Rmxvb3JSZXEub25sb2FkID0gKCkgPT4ge1xyXG4gICAgLy8gICAgIHZhciBmaXJzdEZsb29yU3RvcmVzID0gZmlyc3RGbG9vclJlcS5yZXNwb25zZTtcclxuICAgIC8vICAgICB2YXIgb2JqID0gSlNPTi5wYXJzZShmaXJzdEZsb29yU3RvcmVzKTtcclxuICAgIC8vICAgICBmaXJzdEZsb29yID0gb2JqO1xyXG4gICAgLy8gfVxyXG5cclxuICAgIC8vIHZhciBzdG9yZURhdGE7XHJcbiAgICAvLyB2YXIgc3RvcmVSZXFVUkwgPSAnYXBpL2RhdGEuanNvbic7XHJcbiAgICAvLyB2YXIgc3RvcmVSZXEgPSBuZXcgWE1MSHR0cFJlcXVlc3QoKTtcclxuICAgIC8vIHN0b3JlUmVxLm9wZW4oJ0dFVCcsIHN0b3JlUmVxVVJMKTtcclxuICAgIC8vIHN0b3JlUmVxLnNlbmQoKTtcclxuICAgIC8vIHN0b3JlUmVxLm9ubG9hZCA9ICgpID0+IHtcclxuICAgIC8vICAgICB2YXIgc3RvcmVEYXRhcyA9IHN0b3JlUmVxLnJlc3BvbnNlO1xyXG4gICAgLy8gICAgIHZhciBvYmogPSBKU09OLnBhcnNlKHN0b3JlRGF0YXMpO1xyXG4gICAgLy8gICAgIHN0b3JlRGF0YSA9IG9iajtcclxuICAgIC8vIH1cclxuXHJcbmZ1bmN0aW9uIGRyYXdCYXNpYyhpZCkge1xyXG5cclxuICAgIHZhciBzdG9yZTtcclxuXHJcbiAgICB2YXIgY3VycmVudFRpbWUgPSBuZXcgRGF0ZSgpO1xyXG4gICAgdmFyIGN1cnJlbnRUaW1lQXJyYXkgPSBjdXJyZW50VGltZS50b0xvY2FsZVRpbWVTdHJpbmcoJ2l0LUlUJykuc3BsaXQoJzonKTtcclxuXHJcblxyXG4gICAgZm9yKCB2YXIgaSA9IDA7IGkgPCBncm91bmRGbG9vci5zdG9yZXMubGVuZ3RoOyBpKyspXHJcbiAgICB7XHJcbiAgICAgICAgaWYgKHN0b3JlRGF0YVtpXVsnaWQnXSA9PSBpZClcclxuICAgICAgICB7XHJcbiAgICAgICAgICAgIHN0b3JlID0gaTtcclxuICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG4gICAgZm9yKCB2YXIgaSA9IDA7IGkgPCBmaXJzdEZsb29yLnN0b3Jlcy5sZW5ndGg7IGkrKylcclxuICAgIHtcclxuICAgICAgICBpZiAoc3RvcmVEYXRhW2ldWydpZCddID09IGlkKVxyXG4gICAgICAgIHtcclxuICAgICAgICAgICAgc3RvcmUgPSBpO1xyXG4gICAgICAgICAgICBicmVhaztcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgdmFyIGRhdGEgPSBuZXcgZ29vZ2xlLnZpc3VhbGl6YXRpb24uRGF0YVRhYmxlKCk7XHJcblxyXG4gICAgZGF0YS5hZGRDb2x1bW4oJ3N0cmluZycsICdUaW1lJyk7XHJcbiAgICBkYXRhLmFkZENvbHVtbignbnVtYmVyJywgJ09jY3VwYW5jeScpO1xyXG4gICAgZGF0YS5hZGRDb2x1bW4oJ251bWJlcicsICdOb2lzZScpO1xyXG4gICAgZGF0YS5hZGRDb2x1bW4oJ251bWJlcicsICdIdW1pZGl0eScpO1xyXG4gICAgZGF0YS5hZGRDb2x1bW4oJ251bWJlcicsICdPY2N1cGFuY3kgUHJlZGljdGlvbicpO1xyXG4gICAgZGF0YS5hZGRDb2x1bW4oJ251bWJlcicsICdOb2lzZSBQcmVkaWN0aW9uJyk7XHJcbiAgICBkYXRhLmFkZENvbHVtbignbnVtYmVyJywgJ0h1bWlkaXR5IFByZWRpY3Rpb24nKTtcclxuXHJcblxyXG4gICAgZm9yKCB2YXIgaSA9IDE7IGkgPCA0MTsgaSsrKVxyXG4gICAge1xyXG5cclxuICAgICAgdmFyIHRpbWVzbG90ID0gc3RvcmVEYXRhW3N0b3JlXVsnaGlzdG9yeSddWzBdWyd0aW1lcyddW2ktMV1bJ3RpbWVzbG90J10udG9TdHJpbmcoKTtcclxuICAgICAgdmFyIHRpbWVzbG90QXJyYXkgPSB0aW1lc2xvdC5zcGxpdCgnJyk7XHJcbiAgICAgIFxyXG4gICAgICB2YXIgaG91ciA9IHRpbWVzbG90QXJyYXlbMTFdLmNvbmNhdCh0aW1lc2xvdEFycmF5WzEyXSk7XHJcbiAgICAgIHZhciBtaW4gPSB0aW1lc2xvdEFycmF5WzE0XS5jb25jYXQodGltZXNsb3RBcnJheVsxNV0pO1xyXG4gICAgICB2YXIgdGltZSA9IGhvdXIuY29uY2F0KFwiOlwiKTtcclxuICAgICAgdGltZSA9IHRpbWUuY29uY2F0KG1pbik7XHJcblxyXG4gICAgICBpZihob3VyIDwgY3VycmVudFRpbWVBcnJheVswXSlcclxuICAgICAge1xyXG4gICAgICAgIGRhdGEuYWRkUm93cyhbXHJcbiAgICAgICAgICAgICAgW1xyXG4gICAgICAgICAgICAgICAgICBcclxuICAgICAgICAgICAgICAgICAgdGltZSwgXHJcbiAgICAgICAgICAgICAgICAgIHN0b3JlRGF0YVtzdG9yZV1bJ2hpc3RvcnknXVswXVsndGltZXMnXVtpLTFdWydvY2N1cGFuY3knXSoxMDAsIFxyXG4gICAgICAgICAgICAgICAgICBzdG9yZURhdGFbc3RvcmVdWydoaXN0b3J5J11bMF1bJ3RpbWVzJ11baS0xXVsnbm9pc2UnXSoxMDAsXHJcbiAgICAgICAgICAgICAgICAgIHN0b3JlRGF0YVtzdG9yZV1bJ2hpc3RvcnknXVswXVsndGltZXMnXVtpLTFdWydodW1pZGl0eSddKjEwMCxcclxuICAgICAgICAgICAgICAgICAgbnVsbCxcclxuICAgICAgICAgICAgICAgICAgbnVsbCxcclxuICAgICAgICAgICAgICAgICAgbnVsbFxyXG4gICAgICAgICAgICAgIF1cclxuICAgICAgICAgIF1cclxuICAgICAgICAgICk7XHJcbiAgICAgIH0gZWxzZSBpZiAoaG91ciA9PSBjdXJyZW50VGltZUFycmF5WzBdKXtcclxuICAgICAgICBpZihtaW4gPD0gY3VycmVudFRpbWVBcnJheVsxXSlcclxuICAgICAgICB7XHJcbiAgICAgICAgICBkYXRhLmFkZFJvd3MoW1xyXG4gICAgICAgICAgICAgIFtcclxuICAgICAgICAgICAgICAgICAgXHJcbiAgICAgICAgICAgICAgICAgIHRpbWUsIFxyXG4gICAgICAgICAgICAgICAgICBzdG9yZURhdGFbc3RvcmVdWydoaXN0b3J5J11bMF1bJ3RpbWVzJ11baS0xXVsnb2NjdXBhbmN5J10qMTAwLCBcclxuICAgICAgICAgICAgICAgICAgc3RvcmVEYXRhW3N0b3JlXVsnaGlzdG9yeSddWzBdWyd0aW1lcyddW2ktMV1bJ25vaXNlJ10qMTAwLFxyXG4gICAgICAgICAgICAgICAgICBzdG9yZURhdGFbc3RvcmVdWydoaXN0b3J5J11bMF1bJ3RpbWVzJ11baS0xXVsnaHVtaWRpdHknXSoxMDAsXHJcbiAgICAgICAgICAgICAgICAgIG51bGwsXHJcbiAgICAgICAgICAgICAgICAgIG51bGwsXHJcbiAgICAgICAgICAgICAgICAgIG51bGxcclxuICAgICAgICAgICAgICBdXHJcbiAgICAgICAgICBdXHJcbiAgICAgICAgICApO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICBkYXRhLmFkZFJvd3MoW1xyXG4gICAgICAgICAgICAgIFtcclxuICAgICAgICAgICAgICAgICAgXHJcbiAgICAgICAgICAgICAgICAgIHRpbWUsIFxyXG4gICAgICAgICAgICAgICAgICBudWxsLCBcclxuICAgICAgICAgICAgICAgICAgbnVsbCxcclxuICAgICAgICAgICAgICAgICAgbnVsbCxcclxuICAgICAgICAgICAgICAgICAgc3RvcmVEYXRhW3N0b3JlXVsnaGlzdG9yeSddWzBdWyd0aW1lcyddW2ktMV1bJ29jY3VwYW5jeSddKjEwMCwgXHJcbiAgICAgICAgICAgICAgICAgIHN0b3JlRGF0YVtzdG9yZV1bJ2hpc3RvcnknXVswXVsndGltZXMnXVtpLTFdWydub2lzZSddKjEwMCxcclxuICAgICAgICAgICAgICAgICAgc3RvcmVEYXRhW3N0b3JlXVsnaGlzdG9yeSddWzBdWyd0aW1lcyddW2ktMV1bJ2h1bWlkaXR5J10qMTAwXHJcbiAgICAgICAgICAgICAgXVxyXG4gICAgICAgICAgXVxyXG4gICAgICAgICAgKTtcclxuICAgICAgICB9XHJcbiAgICAgIH1lbHNlIHtcclxuICAgICAgICBkYXRhLmFkZFJvd3MoW1xyXG4gICAgICAgICAgICAgIFtcclxuICAgICAgICAgICAgICAgICAgXHJcbiAgICAgICAgICAgICAgICAgIHRpbWUsIFxyXG4gICAgICAgICAgICAgICAgICBudWxsLCBcclxuICAgICAgICAgICAgICAgICAgbnVsbCxcclxuICAgICAgICAgICAgICAgICAgbnVsbCxcclxuICAgICAgICAgICAgICAgICAgc3RvcmVEYXRhW3N0b3JlXVsnaGlzdG9yeSddWzBdWyd0aW1lcyddW2ktMV1bJ29jY3VwYW5jeSddKjEwMCwgXHJcbiAgICAgICAgICAgICAgICAgIHN0b3JlRGF0YVtzdG9yZV1bJ2hpc3RvcnknXVswXVsndGltZXMnXVtpLTFdWydub2lzZSddKjEwMCxcclxuICAgICAgICAgICAgICAgICAgc3RvcmVEYXRhW3N0b3JlXVsnaGlzdG9yeSddWzBdWyd0aW1lcyddW2ktMV1bJ2h1bWlkaXR5J10qMTAwXHJcbiAgICAgICAgICAgICAgXVxyXG4gICAgICAgICAgXVxyXG4gICAgICAgICAgKTtcclxuICAgICAgfVxyXG4gICAgfVxyXG5cclxuXHJcbiAgICAgIHZhciBvcHRpb25zID0ge1xyXG4gICAgICAgIGhBeGlzOiB7IFxyXG4gICAgICAgICAgc2hvd1RleHRFdmVyeSA6ICc0JyxcclxuICAgICAgICAgIGdyaWRsaW5lcyA6e2NvdW50OiAnMTAnfVxyXG4gICAgICAgIH0sXHJcbiAgICAgICAgdkF4aXM6IHtcclxuICAgICAgICAgIGJhc2VsaW5lOiBcIjBcIlxyXG4gICAgICAgIH0sXHJcbiAgICAgICAgY3VydmVUeXBlOiAnZnVuY3Rpb24nLFxyXG4gICAgICAgIHdpZHRoOiAnNzAwJyxcclxuICAgICAgICBsZWdlbmQ6IHsgcG9zaXRpb246ICdib3R0b20nIH1cclxuICAgICAgfTtcclxuXHJcbiAgICB2YXIgY2hhcnRfZGl2ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2NoYXJ0X2RpdicpO1xyXG4gICAgdmFyIGNoYXJ0ID0gbmV3IGdvb2dsZS52aXN1YWxpemF0aW9uLkxpbmVDaGFydChjaGFydF9kaXYpO1xyXG5cclxuICAgIC8vIFdhaXQgZm9yIHRoZSBjaGFydCB0byBmaW5pc2ggZHJhd2luZyBiZWZvcmUgY2FsbGluZyB0aGUgZ2V0SW1hZ2VVUkkoKSBtZXRob2QuXHJcbiAgICBnb29nbGUudmlzdWFsaXphdGlvbi5ldmVudHMuYWRkTGlzdGVuZXIoY2hhcnQsICdyZWFkeScsIGZ1bmN0aW9uICgpIHsgfSk7XHJcblxyXG4gICAgY2hhcnQuZHJhdyhkYXRhLCBvcHRpb25zKTtcclxuICAgIHJldHVybignPGltZyBzcmM9XCInICsgY2hhcnQuZ2V0SW1hZ2VVUkkoKSArICdcIj4nKTtcclxufSIsIiAgICB2YXIgZ3JvdW5kRmxvb3I7XHJcbiAgICB2YXIgZ3JvdW5kRmxvb3JSZXFVUkwgPSAnYXBpL2dyb3VuZEZsb29yU3RvcmVzLmpzb24nO1xyXG4gICAgdmFyIGdyb3VuZEZsb29yUmVxID0gbmV3IFhNTEh0dHBSZXF1ZXN0KCk7XHJcbiAgICBncm91bmRGbG9vclJlcS5vcGVuKCdHRVQnLCBncm91bmRGbG9vclJlcVVSTCk7XHJcbiAgICBncm91bmRGbG9vclJlcS5zZW5kKCk7XHJcbiAgICBncm91bmRGbG9vclJlcS5vbmxvYWQgPSAoKSA9PiB7XHJcbiAgICAgICAgdmFyIGdyb3VuZEZsb29yU3RvcmVzID0gZ3JvdW5kRmxvb3JSZXEucmVzcG9uc2U7XHJcbiAgICAgICAgdmFyIG9iaiA9IEpTT04ucGFyc2UoZ3JvdW5kRmxvb3JTdG9yZXMpO1xyXG4gICAgICAgIGdyb3VuZEZsb29yID0gb2JqO1xyXG4gICAgfVxyXG5cclxuICAgIHZhciBmaXJzdEZsb29yO1xyXG4gICAgdmFyIGZpcnN0Rmxvb3JSZXFVUkwgPSAnYXBpL2ZpcnN0Rmxvb3JTdG9yZXMuanNvbic7XHJcbiAgICB2YXIgZmlyc3RGbG9vclJlcSA9IG5ldyBYTUxIdHRwUmVxdWVzdCgpO1xyXG4gICAgZmlyc3RGbG9vclJlcS5vcGVuKCdHRVQnLCBmaXJzdEZsb29yUmVxVVJMKTtcclxuICAgIGZpcnN0Rmxvb3JSZXEuc2VuZCgpO1xyXG4gICAgZmlyc3RGbG9vclJlcS5vbmxvYWQgPSAoKSA9PiB7XHJcbiAgICAgICAgdmFyIGZpcnN0Rmxvb3JTdG9yZXMgPSBmaXJzdEZsb29yUmVxLnJlc3BvbnNlO1xyXG4gICAgICAgIHZhciBvYmogPSBKU09OLnBhcnNlKGZpcnN0Rmxvb3JTdG9yZXMpO1xyXG4gICAgICAgIGZpcnN0Rmxvb3IgPSBvYmo7XHJcbiAgICB9XHJcblxyXG4gICAgdmFyIHN0b3JlRGF0YTtcclxuICAgIHZhciBzdG9yZVJlcVVSTCA9ICdhcGkvZGF0YS5qc29uJztcclxuICAgIHZhciBzdG9yZVJlcSA9IG5ldyBYTUxIdHRwUmVxdWVzdCgpO1xyXG4gICAgc3RvcmVSZXEub3BlbignR0VUJywgc3RvcmVSZXFVUkwpO1xyXG4gICAgc3RvcmVSZXEuc2VuZCgpO1xyXG4gICAgc3RvcmVSZXEub25sb2FkID0gKCkgPT4ge1xyXG4gICAgICAgIHZhciBzdG9yZURhdGFzID0gc3RvcmVSZXEucmVzcG9uc2U7XHJcbiAgICAgICAgdmFyIG9iaiA9IEpTT04ucGFyc2Uoc3RvcmVEYXRhcyk7XHJcbiAgICAgICAgc3RvcmVEYXRhID0gb2JqO1xyXG4gICAgfVxyXG4iLCJmdW5jdGlvbiBzZXRFbnRpdHlIaWdobGlnaHRzKCkge1xyXG4gICAgdXBkYXRlTWFwRnJvbVNsaWRlcnMoKTtcclxufVxyXG5mdW5jdGlvbiBzZXRTdG9yZUhpZ2hsaWdodHMoc3RvcmUsIGNvbG91cil7XHJcbiAgICBzdG9yZSA9IHN0b3JlLnRvU3RyaW5nKCk7XHJcbiAgICBtYXAuaW5kb29ycy5zZXRFbnRpdHlIaWdobGlnaHRzKHN0b3JlLCBjb2xvdXIpO1xyXG59XHJcblxyXG5mdW5jdGlvbiByYW5kb21Db2xvcigpe1xyXG4gICAgdmFyIHJlZCA9IE1hdGguZmxvb3IoTWF0aC5yYW5kb20oKSAqIDI1Nik7XHJcbiAgICB2YXIgZ3JlZW4gPSAyNTUgLSByZWQ7XHJcbiAgICByZXR1cm4gW3JlZCwgZ3JlZW4sIDAsIDIwMF07XHJcbn1cclxuXHJcbmZ1bmN0aW9uIGNsZWFyRW50aXR5SGlnaGxpZ2h0cygpe1xyXG4gICAgbWFwLmluZG9vcnMuY2xlYXJFbnRpdHlIaWdobGlnaHRzKCk7XHJcbn0iLCJ2YXIgbWFwID0gTC5XcmxkLm1hcChcIm1hcFwiLCBcIjlkODc2NjQ2ZjdkODNjYzcwOWVkYmUyMDRjODFkNTQ2XCIsIHtcclxuICAgIGNlbnRlcjogWzU2LjQ1OTgsIC0yLjk3MjhdLFxyXG4gICAgem9vbTogMTcsXHJcbiAgICBpbmRvb3JzRW5hYmxlZDogdHJ1ZVxyXG59KTtcclxuICB2YXIgaW5kb29yQ29udHJvbCA9IG5ldyBXcmxkSW5kb29yQ29udHJvbChcIndpZGdldC1jb250YWluZXJcIiwgbWFwKTtcclxuICB2YXIgY3VycmVudEluZG9vck1hcElkO1xyXG4gIHZhciBjdXJyZW50Rmxvb3I7XHJcbiAgdmFyIGVudGl0eUlkc1RvUG9zaXRpb24gPSB7fTtcclxuICB2YXIgZDtcclxuICB2YXIgcG9wdXA7XHJcbiAgXHJcbiAgdmFyIGxhc3RNb3VzZURvd247XHJcbiAgZnVuY3Rpb24gb25Nb3VzZURvd24oZXZlbnQpIHtcclxuICAgIGxhc3RNb3VzZURvd24gPSBldmVudC5sYXRsbmc7XHJcbiAgfVxyXG4gIFxyXG4gIGZ1bmN0aW9uIG9uSW5kb29yRW50aXR5Q2xpY2tlZChldmVudCkge1xyXG4gICAgZXZlbnQuaWRzLmZvckVhY2goaWRlbnRpZnlFbnRpdHkpO1xyXG4gIH1cclxuXHJcbiAgZnVuY3Rpb24gZXhwb3J0SWRNYXAoKSB7XHJcbiAgICBjb25zb2xlLmxvZyhKU09OLnN0cmluZ2lmeShlbnRpdHlJZHNUb1Bvc2l0aW9uKSk7XHJcbiAgfVxyXG4gIFxyXG4gIGZ1bmN0aW9uIG9uSW5kb29yTWFwRW50ZXJlZChldmVudCkge1xyXG4gICAgbWFwLmluZG9vcnMuc2V0Rmxvb3IoMCk7XHJcbiAgICBtYXAuc2V0VmlldyhbNTYuNDU5OCwgLTIuOTcyOF0sIDE3KTtcclxuICAgIGN1cnJlbnRJbmRvb3JNYXBJZCA9IGV2ZW50LmluZG9vck1hcC5nZXRJbmRvb3JNYXBJZCgpO1xyXG4gICAgY3VycmVudEZsb29yID0gbWFwLmluZG9vcnMuZ2V0Rmxvb3IoKS5nZXRGbG9vckluZGV4KCk7XHJcbiAgfVxyXG4gIFxyXG4gIGZ1bmN0aW9uIG9uSW5kb29yTWFwRmxvb3JDaGFuZ2VkKCkge1xyXG4gICAgY3VycmVudEZsb29yID0gbWFwLmluZG9vcnMuZ2V0Rmxvb3IoKS5nZXRGbG9vckluZGV4KCk7XHJcbiAgfVxyXG5cclxuICBmdW5jdGlvbiBnZXRTdG9yZU5hbWUoaWQpe1xyXG4gICAgaWYoY3VycmVudEZsb29yID09IDApXHJcbiAgICB7XHJcbiAgICAgIGZvcih2YXIgaSA9IDA7IGkgPCBncm91bmRGbG9vci5zdG9yZXMubGVuZ3RoOyBpKyspXHJcbiAgICAgIHtcclxuICAgICAgICBpZihncm91bmRGbG9vci5zdG9yZXNbaV0uaWQgPT0gaWQpXHJcbiAgICAgICAge1xyXG4gICAgICAgICAgLy9jb25zb2xlLmxvZyhncm91bmRGbG9vci5zdG9yZXNbaV0uc3RvcmUpO1xyXG4gICAgICAgICAgcmV0dXJuIGdyb3VuZEZsb29yLnN0b3Jlc1tpXS5zdG9yZTtcclxuICAgICAgICB9XHJcbiAgICAgIH1cclxuICAgIH1cclxuICB9XHJcblxyXG4gIGZ1bmN0aW9uIHZhbGlkSWQoaWQpIHtcclxuXHJcbiAgICBmb3IoIHZhciBpID0gMDsgaSA8IGdyb3VuZEZsb29yLnN0b3Jlcy5sZW5ndGg7IGkrKylcclxuICAgIHtcclxuICAgICAgICAgIGlmIChzdG9yZURhdGFbaV1bJ2lkJ10gPT0gaWQpXHJcbiAgICAgICAgICB7XHJcbiAgICAgICAgICAgICAgcmV0dXJuIGk7XHJcbiAgICAgICAgICB9XHJcbiAgICB9XHJcbiAgICBmb3IoIHZhciBpID0gMDsgaSA8IGZpcnN0Rmxvb3Iuc3RvcmVzLmxlbmd0aDsgaSsrKVxyXG4gICAge1xyXG4gICAgICAgICAgaWYgKHN0b3JlRGF0YVtpXVsnaWQnXSA9PSBpZClcclxuICAgICAgICAgIHtcclxuICAgICAgICAgICAgICByZXR1cm4gaTtcclxuICAgICAgICAgIH1cclxuICAgIH1cclxuICAgIHJldHVybiBudWxsO1xyXG59XHJcbiAgXHJcbiAgZnVuY3Rpb24gaWRlbnRpZnlFbnRpdHkoaWQpIHtcclxuICAgIHZhciBsYXRMbmcgPSBsYXN0TW91c2VEb3duO1xyXG4gICAgZCA9IG5ldyBEYXRlKCk7XHJcblxyXG4gICAgdmFyIHZhbGlkID0gdmFsaWRJZChpZCk7XHJcblxyXG4gICAgaWYodmFsaWQgIT0gbnVsbClcclxuICAgIHtcclxuICAgICAgbWFwLnNldFZpZXcobGF0TG5nLCAxNyk7XHJcbiAgICAgIFxyXG4gICAgICB2YXIgcG9wdXBPcHRpb25zID0geyBcclxuICAgICAgICBpbmRvb3JNYXBJZDogY3VycmVudEluZG9vck1hcElkLCBcclxuICAgICAgICBpbmRvb3JNYXBGbG9vckluZGV4OiBjdXJyZW50Rmxvb3IsIFxyXG4gICAgICAgIGF1dG9DbG9zZTogdHJ1ZSwgXHJcbiAgICAgICAgY2xvc2VPbkNsaWNrOiB0cnVlLFxyXG4gICAgICAgIG1pbldpZHRoOiBcIjcwMFwiICAgICAgICAgIFxyXG4gICAgICB9O1xyXG4gICAgICBwb3B1cCA9IEwucG9wdXAocG9wdXBPcHRpb25zKVxyXG4gICAgICAgIC5zZXRMYXRMbmcobGF0TG5nKVxyXG4gICAgICAgIC5hZGRUbyhtYXApXHJcbiAgICAgICAgLnNldENvbnRlbnQoY3JlYXRlTW9ja0hUTUxFbGVtZW50KGlkLCBkLCBkcmF3QmFzaWMoaWQpKSk7XHJcbiAgICAgIGVudGl0eUlkc1RvUG9zaXRpb25baWRdID0geyBcImxhdExuZ1wiOiBsYXRMbmcsIFwiaW5kb29ySWRcIjogY3VycmVudEluZG9vck1hcElkLCBcImZsb29ySW5kZXhcIjogY3VycmVudEZsb29yIH0gO1xyXG4gICAgfVxyXG5cclxuICAgIHNldFRpbWVvdXQodXBkYXRlUG9wdXAoaWQsIGQpLCA1MDAwKTtcclxuICB9XHJcblxyXG4gIGZ1bmN0aW9uIHVwZGF0ZVBvcHVwKGlkLCBkKVxyXG4gIHtcclxuICAgIGQgPSBuZXcgRGF0ZSgpO1xyXG4gICAgY29uc29sZS5sb2coZC50b0xvY2FsZVRpbWVTdHJpbmcoJ2l0LUlUJykpO1xyXG4gICAgcG9wdXAuc2V0Q29udGVudChjcmVhdGVNb2NrSFRNTEVsZW1lbnQoaWQsIGQsIGRyYXdCYXNpYyhpZCkpKTtcclxuICB9XHJcblxyXG4gIG1hcC5pbmRvb3JzLm9uKFwiaW5kb29ybWFwZW50ZXJcIiwgb25JbmRvb3JNYXBFbnRlcmVkKTtcclxuICBtYXAuaW5kb29ycy5vbihcImluZG9vcm1hcGZsb29yY2hhbmdlXCIsIG9uSW5kb29yTWFwRmxvb3JDaGFuZ2VkKVxyXG4gIG1hcC5pbmRvb3JzLm9uKFwiaW5kb29yZW50aXR5Y2xpY2tcIiwgb25JbmRvb3JFbnRpdHlDbGlja2VkKTtcclxuICBtYXAub24oXCJtb3VzZWRvd25cIiwgb25Nb3VzZURvd24pO1xyXG5cclxuICBmdW5jdGlvbiBjcmVhdGVNb2NrSFRNTEVsZW1lbnQoaWQsIGRhdGUsIGdyYXBoVGV4dCl7XHJcbiAgICB2YXIgZ3JhcGhIVE1MID0gJzxkaXYgY2xhc3M9XCJjb250ZW50XCI+JyArXHJcbiAgICAgICAgICAgICAgICAgICAgJzxoMj4nKyBnZXRTdG9yZU5hbWUoaWQpICsgICcgJyArIGQudG9Mb2NhbGVUaW1lU3RyaW5nKCdpdC1JVCcpICtcclxuICAgICAgICAgICAgICAgICAgICBncmFwaFRleHQgK1xyXG4gICAgICAgICAgICAgICAgICAgICc8L2Rpdj4nO1xyXG4gICAgcmV0dXJuIGdyYXBoSFRNTDtcclxufVxyXG5cclxuXHJcblxyXG5cclxuXHJcbi8qICAgICAgICAgICAgICAgICAgJzxkaXYgY2xhc3M9XCJjb250ZW50XCI+JyArXHJcbiAgICAgICAgICAgICAgICAgICAgJzxoMj4nKyBnZXRTdG9yZU5hbWUoaWQpICsgJyBmb3IgdGhlICcgKyBkLmdldERhdGUoKSArICcgb2YgU3BldGVtYmVyIDIwMTg8L2gyPicgK1xyXG4gICAgICAgICAgICAgICAgICAgIGdyYXBoVGV4dCArXHJcbiAgICAgICAgICAgICAgICAgICAgJzwvZGl2Pic7XHJcbiovXHJcblxyXG5cclxuXHJcbiIsIi8vT25sb2FkIGZ1bmN0aW9uIHRvIHNldHVwIHNsaWRlcnNcclxud2luZG93Lm9ubG9hZCA9IGZ1bmN0aW9uICgpe1xyXG4gICAgdmFyIHNsaWRlcnMgPSBkb2N1bWVudC5nZXRFbGVtZW50c0J5Q2xhc3NOYW1lKFwicmFuZ2VQaWNrZXJcIik7XHJcbiAgICAvLyB2YXIgdGV4dEJveGVzID0gZG9jdW1lbnQuZ2V0RWxlbWVudHNCeUNsYXNzTmFtZShcInRleHRCb3hcIik7XHJcbiAgICBbXS5mb3JFYWNoLmNhbGwoc2xpZGVycywgZnVuY3Rpb24gKHNsaWRlcikgeyAgICBcclxuICAgICAgICBzbGlkZXIubWluID0gMTtcclxuICAgICAgICBzbGlkZXIubWF4ID0gNTtcclxuICAgICAgICBzbGlkZXIuc3RlcCA9IDE7XHJcbiAgICAgICAgc2xpZGVyLnZhbHVlID0gMztcclxuICAgIH0pO1xyXG5cclxuICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKFwiU0FEXCIpLmFkZEV2ZW50TGlzdGVuZXIoXCJjbGlja1wiLCBwcmVzZXRzVXBkYXRlKDApKTtcclxuICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKFwiR09PRFwiKS5hZGRFdmVudExpc3RlbmVyKFwiY2xpY2tcIiwgcHJlc2V0c1VwZGF0ZSgyKSk7XHJcbiAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChcIk5PUk1BTFwiKS5hZGRFdmVudExpc3RlbmVyKFwiY2xpY2tcIiwgcHJlc2V0c1VwZGF0ZSgxKSk7XHJcbn1cclxuXHJcbmZ1bmN0aW9uIHByZXNldHNVcGRhdGUobGV2ZWwpe1xyXG4gICAgdmFyIG9jY3VwYW5jeSA9IFsxLDMsNV07XHJcbiAgICB2YXIgbm9pc2UgPSBbMSwzLDVdO1xyXG4gICAgdmFyIGh1bWlkaXR5ID0gWzEsMyw1XTtcclxuXHJcbiAgICBmb3IodmFyIGk9MDsgaSA8IDM7IGkrKyl7XHJcbiAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoXCJvY2N1cGFuY3ktc2xpZGVyXCIpLnZhbHVlID0gb2NjdXBhbmN5W2xldmVsXTtcclxuICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChcIm5vaXNlLXNsaWRlclwiKS52YWx1ZSA9IG5vaXNlW2xldmVsXTtcclxuICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChcImh1bWlkaXR5LXNsaWRlclwiKS52YWx1ZSA9IGh1bWlkaXR5W2xldmVsXTtcclxuICAgIH1cclxufSIsIi8vIENhbGxlZCB3aGVuIGEgc2xpZGVyIGlzIHVwZGF0ZWQuIFxyXG5mdW5jdGlvbiB1cGRhdGVNYXBGcm9tU2xpZGVycygpeyBcclxuICAgIHZhciBzdG9yZXMgPSBzdG9yZURhdGE7XHJcbiAgICB2YXIgY3VycmVudCA9IGdldEN1cnJlbnRTbGlkZXJMZXZlbCgpO1xyXG4gICAgdmFyIHNsaWRlck9jY3VwYW5jeSA9IGN1cnJlbnRbMF0vNTtcclxuICAgIHZhciBzbGlkZXJOb2lzZSA9IGN1cnJlbnRbMV0vNTtcclxuICAgIHZhciBzbGlkZXJIdW1pZGl0eSA9IGN1cnJlbnRbMl0vNTtcclxuICAgIGNvbnNvbGUubG9nKFwiU2xpZGVyIFZhbHVlczogXCIgKyBzbGlkZXJPY2N1cGFuY3kgKyBcIiBcIiArIHNsaWRlck5vaXNlICsgXCIgXCIgKyBzbGlkZXJIdW1pZGl0eSk7XHJcblxyXG4gICAgZm9yKHZhciBpID0gMDsgaSA8IHN0b3Jlcy5sZW5ndGg7IGkrKyl7XHJcbiAgICAgICAgdmFyIHN0b3JlSUQgPSBzdG9yZXNbaV0uaWQ7XHJcbiAgICAgICAgdmFyIGN1cnJlbnRPY2N1cGFuY3kgPSBzdG9yZXNbaV0uaGlzdG9yeVswXS50aW1lc1swXS5vY2N1cGFuY3k7XHJcbiAgICAgICAgdmFyIGN1cnJlbnROb2lzZSA9IHN0b3Jlc1tpXS5oaXN0b3J5WzBdLnRpbWVzWzBdLm5vaXNlO1xyXG4gICAgICAgIHZhciBjdXJyZW50SHVtaWRpdHkgPSBzdG9yZXNbaV0uaGlzdG9yeVswXS50aW1lc1swXS5odW1pZGl0eTtcclxuXHJcbiAgICAgICAgY29uc29sZS5sb2coXCJWYWx1ZXM6IFwiICsgY3VycmVudE9jY3VwYW5jeSArIFwiIFwiICsgY3VycmVudE5vaXNlICsgXCIgXCIgKyBjdXJyZW50SHVtaWRpdHkpO1xyXG5cclxuICAgICAgICBcclxuICAgICAgICBpZihjdXJyZW50T2NjdXBhbmN5ID49IHNsaWRlck9jY3VwYW5jeSAmJiBjdXJyZW50Tm9pc2UgPj0gc2xpZGVyTm9pc2UgJiYgY3VycmVudEh1bWlkaXR5ID49IHNsaWRlckh1bWlkaXR5KXtcclxuICAgICAgICAgICAgc2V0U3RvcmVIaWdobGlnaHRzKHN0b3JlSUQsIFsxMDgsMjQ5LDMyLCAyMDBdKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgZWxzZSBpZihjdXJyZW50T2NjdXBhbmN5IDwgc2xpZGVyT2NjdXBhbmN5ICYmIGN1cnJlbnROb2lzZSA8IHNsaWRlck5vaXNlICYmIGN1cnJlbnRIdW1pZGl0eSA8IHNsaWRlckh1bWlkaXR5KXtcclxuICAgICAgICBcdHNldFN0b3JlSGlnaGxpZ2h0cyhzdG9yZUlELCBbMjQ5LDcxLDMyLCAyMDBdKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgZWxzZXtcclxuICAgICAgICBcdHNldFN0b3JlSGlnaGxpZ2h0cyhzdG9yZUlELCBbMjQ5LDIzOSwzMiwgMjAwXSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIC8qXHJcbiAgICAgICAgZWxzZSBpZigoY3VycmVudE9jY3VwYW5jeSA+IHNsaWRlck9jY3VwYW5jeSAmJiBjdXJyZW50T2NjdXBhbmN5IDwgc2xpZGVyT2NjdXBhbmN5ICsgMC4xKSB8fCAoY3VycmVudE5vaXNlID4gc2xpZGVyTm9pc2UgJiYgY3VycmVudE5vaXNlIDwgc2xpZGVyTm9pc2UgKyAwLjEpIHx8IChjdXJyZW50SHVtaWRpdHkgPiBzbGlkZXJIdW1pZGl0eSAmJiBjdXJyZW50SHVtaWRpdHkgPCBzbGlkZXJIdW1pZGl0eSArIDAuMSkpe1xyXG4gICAgICAgIFx0c2V0U3RvcmVIaWdobGlnaHRzKHN0b3JlSUQsIFsyNDksMjM5LDMyLCAyMDBdKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgZWxzZXtcclxuICAgICAgICBcdHNldFN0b3JlSGlnaGxpZ2h0cyhzdG9yZUlELCBbMjQ5LDcxLDMyLCAyMDBdKTtcclxuICAgICAgICB9Ki9cclxuICAgIH1cclxuXHJcbn1cclxuXHJcbi8vIEdldHMgY3VycmVudCBsZXZlbHMgc2xpZGVycyBhcmUgYXQsIHBhcnNlcyB0aGVtIGludG8gbnVtYmVycy5cclxuLy8gUmV0dXJucyBhcyBhbiBhcnJheS5cclxuZnVuY3Rpb24gZ2V0Q3VycmVudFNsaWRlckxldmVsKCl7XHJcbiAgICB2YXIgc2xpZGVyQXJyYXkgPVtdO1xyXG4gICAgdmFyIHNsaWRlcnMgPSBkb2N1bWVudC5nZXRFbGVtZW50c0J5Q2xhc3NOYW1lKFwicmFuZ2VQaWNrZXJcIik7XHJcbiAgICBbXS5mb3JFYWNoLmNhbGwoc2xpZGVycywgZnVuY3Rpb24gKHNsaWRlcikge1xyXG4gICAgICAgIHNsaWRlckFycmF5LnB1c2gocGFyc2VJbnQoc2xpZGVyLnZhbHVlLCAxMCkpO1xyXG4gICAgfSk7XHJcbiAgICBjb25zb2xlLmxvZyhcIlNsaWRlciBWYWx1ZXM6IFwiICsgc2xpZGVyQXJyYXkpO1xyXG4gICAgcmV0dXJuIHNsaWRlckFycmF5O1xyXG59XHJcbiJdfQ==
